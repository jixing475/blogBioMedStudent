---
title: "Machine Learning review with an intro to the tidymodels package"
description: |
  A short description of the post.
author:
  - name: Jixing Liu
    url: https://emitanaka.org
date: 06-24-2021
draft: false
categories: [machine learning, R]
output:
  distill::distill_article:
    self_contained: false
    highlight: default
    toc: true
    #highlight_downlit: false # downlit makes attr.source not work
    toc_float: true
    keep_md: yes
preview: "ml-review_images/image-20210624170933171.png"
---



<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'></div>

</div>


<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'></div>

</div>


## Follow along

You can download this .Rmd file below if you'd like to follow along. I do have a few hidden notes you can disregard. This document is a distill_article, so you may want to change to an html_document to knit. You will also need to delete any image references to properly knit, since you won't have those images.

<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'>
```{=html}
<a href="data:text/x-markdown;base64,LS0tCnRpdGxlOiAiTWFjaGluZSBMZWFybmluZyByZXZpZXcgd2l0aCBhbiBpbnRybyB0byB0aGUgdGlkeW1vZGVscyBwYWNrYWdlIgpkZXNjcmlwdGlvbjogfAogIEEgc2hvcnQgZGVzY3JpcHRpb24gb2YgdGhlIHBvc3QuCmF1dGhvcjoKICAtIG5hbWU6IEppeGluZyBMaXUKICAgIHVybDogaHR0cHM6Ly9lbWl0YW5ha2Eub3JnCmRhdGU6IDA2LTI0LTIwMjEKZHJhZnQ6IGZhbHNlCmNhdGVnb3JpZXM6IFttYWNoaW5lIGxlYXJuaW5nLCBSXQpvdXRwdXQ6CiAgZGlzdGlsbDo6ZGlzdGlsbF9hcnRpY2xlOgogICAgc2VsZl9jb250YWluZWQ6IGZhbHNlCiAgICBoaWdobGlnaHQ6IGRlZmF1bHQKICAgIHRvYzogdHJ1ZQogICAgI2hpZ2hsaWdodF9kb3dubGl0OiBmYWxzZSAjIGRvd25saXQgbWFrZXMgYXR0ci5zb3VyY2Ugbm90IHdvcmsKICAgIHRvY19mbG9hdDogdHJ1ZQogICAga2VlcF9tZDogeWVzCnByZXZpZXc6ICJpc2xydHJlZWJhc2VkbWV0aG9kc19waG90by9pbWFnZS0yMDIxMDYxNzE3MTQ0MzU2Ny5wbmciCi0tLQoKYGBge3Iga25pdC1zZXR1cCwgaW5jbHVkZT1GQUxTRX0Ka25pdHI6OmtuaXRfaG9va3Mkc2V0KHRvZ2dsZSA9IGZ1bmN0aW9uKGJlZm9yZSwgb3B0aW9ucykgewogIGlmKG9wdGlvbnMkdG9nZ2xlKSB7CiAgICBpZmVsc2UoYmVmb3JlLCAiPGRpdiBjbGFzcz0ndG9nZ2xlLWNvZGUnPiIsICI8L2Rpdj4iKQogIH0KfSkKCgprbml0cjo6b3B0c19jaHVuayRzZXQoZWNobyA9IFRSVUUsIAogICAgICAgICAgICAgICAgICAgICAgdG9nZ2xlID0gVFJVRSwKICAgICAgICAgICAgICAgICAgICAgIGNhY2hlID0gVFJVRSwKICAgICAgICAgICAgICAgICAgICAgIGNhY2hlLnBhdGggPSAiY2FjaGUvIiwKICAgICAgICAgICAgICAgICAgICAgIGZpZy5hbGlnbiA9ICJjZW50ZXIiLAogICAgICAgICAgICAgICAgICAgICAgZmlnLnBhdGggPSAiZmlndXJlcy8iKQoKYGBgCgpgYGB7ciBlY2hvPUZBTFNFfQpsaWJyYXJ5KGVtbykgICAgICAgICAgIyBmb3IgZW1vamlzISAgIApsaWJyYXJ5KGRvd25sb2FkdGhpcykgIyBmb3IgaW5jbHVkaW5nIGRvd25sb2FkIGJ1dHRvbnMgZm9yIGZpbGVzCmxpYnJhcnkoRGF0YUV4cGxvcmVyKQpgYGAKCmBgYHtyIHBhZ2VkLXRhYmxlLCBlY2hvPUZBTFNFfQojIGRlZmluZSBhIG1ldGhvZCBmb3Igb2JqZWN0cyBvZiB0aGUgY2xhc3MgZGF0YS5mcmFtZQojIHNlZSBodHRwczovL2dpdGh1Yi5jb20vcnN0dWRpby9kaXN0aWxsL2lzc3Vlcy8zMTAjaXNzdWVjb21tZW50LTc5NzU0MTQ1OQpsaWJyYXJ5KGtuaXRyKQprbml0X3ByaW50LmRhdGEuZnJhbWUgPC0gZnVuY3Rpb24oeCwgLi4uKSB7CiAgYXNpc19vdXRwdXQoCiAgICBybWFya2Rvd246OjpwYWdlZF90YWJsZV9odG1sKHgsIG9wdGlvbnMgPSBhdHRyKHgsICJvcHRpb25zIikpLAogICAgbWV0YSA9IGxpc3QoZGVwZW5kZW5jaWVzID0gcm1hcmtkb3duOjo6aHRtbF9kZXBlbmRlbmN5X3BhZ2VkdGFibGUoKSkKICApCn0KcmVnaXN0ZXJTM21ldGhvZCgia25pdF9wcmludCIsICJkYXRhLmZyYW1lIiwga25pdF9wcmludC5kYXRhLmZyYW1lKQpgYGAKCiMjIEZvbGxvdyBhbG9uZwoKWW91IGNhbiBkb3dubG9hZCB0aGlzIC5SbWQgZmlsZSBiZWxvdyBpZiB5b3UnZCBsaWtlIHRvIGZvbGxvdyBhbG9uZy4gSSBkbyBoYXZlIGEgZmV3IGhpZGRlbiBub3RlcyB5b3UgY2FuIGRpc3JlZ2FyZC4gVGhpcyBkb2N1bWVudCBpcyBhIGRpc3RpbGxfYXJ0aWNsZSwgc28geW91IG1heSB3YW50IHRvIGNoYW5nZSB0byBhbiBodG1sX2RvY3VtZW50IHRvIGtuaXQuIFlvdSB3aWxsIGFsc28gbmVlZCB0byBkZWxldGUgYW55IGltYWdlIHJlZmVyZW5jZXMgdG8gcHJvcGVybHkga25pdCwgc2luY2UgeW91IHdvbid0IGhhdmUgdGhvc2UgaW1hZ2VzLgoKYGBge3IsIGVjaG89RkFMU0V9CmRvd25sb2FkX2ZpbGUoCiAgcGF0aCA9IGhlcmU6OmhlcmUoIl9wb3N0cy8yMDIxLTA2LTI0LW1sLXJldmlldy9tbC1yZXZpZXcuUm1kIiksCiAgYnV0dG9uX2xhYmVsID0gIkRvd25sb2FkIC5SbWQgZmlsZSIsCiAgYnV0dG9uX3R5cGUgPSAiaW5mbyIsCiAgaGFzX2ljb24gPSBUUlVFLAogIGljb24gPSAiZmEgZmEtc2F2ZSIsCiAgc2VsZl9jb250YWluZWQgPSBGQUxTRQopCmBgYAoKIyMgUmVzb3VyY2VzCgpIZXJlIGFyZSBzb21lIGdyZWF0IHJlc291cmNlcy4gSSB3aWxsIHJlZmVyZW5jZSBzb21lIG9mIHRoZW0gdGhyb3VnaG91dC4KCiogW0hhbmRzIG9uIE1hY2hpbmUgTGVhcm5pbmcgd2l0aCBSXShodHRwczovL2JyYWRsZXlib2VobWtlLmdpdGh1Yi5pby9IT01MLykgKEhPTUwsIGZvciBzaG9ydCkgYnkgQnJhZGxleSBCb2VobWtlIGFuZCBCcmFuZG9uIEdyZWVud2VsbCBpcyB0aGUgdGV4dGJvb2sgSSB1c2VkIGluIHRoZSBNYWNoaW5lIExlYXJuaW5nIGNvdXJzZSBJIHRhdWdodCBpbiBzcHJpbmcgb2YgMjAyMC4gSXQgaXMgYSBncmVhdCBwbGFjZSB0byBnbyB0byByZXZpZXcgc29tZSBvZiB0aGUgbW9kZWwgYWxnb3JpdGhtcyBhbmQgY29uY2VwdHMuICAKCiogW0lTTFJdKGh0dHBzOi8vd3d3LnN0YXRsZWFybmluZy5jb20vKSBieSBKYW1lcywgV2l0dGVuLCBIYXN0aWUsIGFuZCBUaWJzaGlyYW5pIGdvZXMgZGVlcGVyIGludG8gdGhlIG1hdGggb2YgdGhlIGFsZ29yaXRobXMuIFlvdSBjYW4gZG93bmxvYWQgdGhlaXIgYm9vayBhdCB0aGlzIHNpdGUuCgoqIFRpZHltb2RlbHMKICAtIFtMaXNhJ3MgdGlkeW1vZGVscyBub1J0aCBwcmVzZW50YXRpb25dKGh0dHBzOi8veW91dHUuYmUvdFZaTy1hb1hTdEUpIGdpdmVzIGFuIGV4YW1wbGUgb2YgdXNpbmcgYHRpZHltb2RlbHNgLiBJIHdpbGwgZ28gdGhyb3VnaCB0aGUgc2FtZSBleGFtcGxlIGJlbG93LCB3aXRoIGEgZmV3IGFkZGVkIHBhcnRzLiBUaGUgY29kZSBoYXMgY2hhbmdlZCBzbGlnaHRseSBpbiBzb21lIHBsYWNlcywgdG9vLgogIC0gW3RpZHltb2RlbHMub3JnXShodHRwczovL3d3dy50aWR5bW9kZWxzLm9yZy8pLCBzcGVjaWZpY2FsbHkgdGhlIFtjYXNlIHN0dWR5XShodHRwczovL3d3dy50aWR5bW9kZWxzLm9yZy9zdGFydC9jYXNlLXN0dWR5LyksIHdhbGtzIHRocm91Z2ggZXhhbXBsZXMgb2YgdXNpbmcgdGhlIGB0aWR5bW9kZWxzYCBzdWl0ZS4gIAogIC0gW1RpZHkgTW9kZWxzIHdpdGggUiB0ZXh0Ym9va10oaHR0cHM6Ly93d3cudG13ci5vcmcvKSBieSBKdWxpYSBTaWxnZSBhbmQgTWF4IEt1aG4gcHJvdmlkZXMgbW9yZSBpbi1kZXB0aCBleHBsYW5hdGlvbnMgb2YgdGhlIGB0aWR5bW9kZWxzYCBmdW5jdGlvbnMgd2l0aCBleHRlbmRlZCBleGFtcGxlcy4KICAtIFtKdWxpYSBTaWxnZSdzIGJsb2ddKGh0dHBzOi8vanVsaWFzaWxnZS5jb20vKSB3aXRoIGV2ZW4gbW9yZSBleGFtcGxlcyEKCiMjIFJldmlldwoKTW9zdCBvZiB5b3UgcHJvYmFibHkgbGVhcm5lZCBhYm91dCBtYWNoaW5lIGxlYXJuaW5nIGFsZ29yaXRobXMgdXNpbmcgdGhlIGBjYXJldGAgUiBwYWNrYWdlLiBCZWZvcmUganVtcGluZyBpbnRvIHRoZSBuZXcgYHRpZHltb2RlbHNgIHBhY2thZ2UsIGxldCdzIHJlbWVtYmVyIHNvbWUgb2YgdGhlIGtleSBtYWNoaW5lIGxlYXJuaW5nIGNvbmNlcHRzLiAKCkxldCdzIHN0YXJ0IHdpdGggYW4gb3ZlcnZpZXcgb2YgdGhlIHByb2Nlc3MuIFlvdSBjb3ZlcmVkIG1hbnkgb2YgdGhlc2UgaW4geW91ciBtYWNoaW5lIGxlYXJuaW5nIGNvdXJzZS4gSWYgeW91IG5lZWQgbW9yZSBvZiBhIHJlZnJlc2hlciB0aGFuIHdoYXQgSSBwcm92aWRlLCBzZWUgdGhlIFsqTW9kZWxpbmcgUHJvY2VzcypdKGh0dHBzOi8vYnJhZGxleWJvZWhta2UuZ2l0aHViLmlvL0hPTUwvcHJvY2Vzcy5odG1sKSBjaGFwdGVyIG9mIEhPTUwuCgo+IFtIYW5kcy1PbiBNYWNoaW5lIExlYXJuaW5nIHdpdGggUl0oaHR0cHM6Ly9icmFkbGV5Ym9laG1rZS5naXRodWIuaW8vSE9NTC9pbmRleC5odG1sKQo+Cj4g6L+Z5piv5LiA5pys5b6I5qOS55qE6K6y5py65Zmo5a2m5Lmg55qE5Lmm57GNCgoKCiFbaW1hZ2UtMjAyMTA2MjQxNDM5NDQ4MDRdKG1sLXJldmlld19pbWFnZXMvaW1hZ2UtMjAyMTA2MjQxNDM5NDQ4MDQucG5nKQoKPGRpdiBjbGFzcz0iY2VudGVyZWQiPgo8L2Rpdj4KCgohW2ltYWdlLTIwMjEwNjI0MTQzNDA3OTc0XShtbC1yZXZpZXdfaW1hZ2VzL2ltYWdlLTIwMjEwNjI0MTQzNDA3OTc0LnBuZykKCkFuZCBsZXQncyByZXZpZXcgd2hhdCB3ZSBkbyBkdXJpbmcgZWFjaCBvZiB0aGVzZSBzdGVwcy4KCjEuICoqUXVpY2sgZXhwbG9yYXRpb24qKjogKipSZWFkKiogaW4gdGhlIGRhdGEsIGNoZWNrICoqdmFyaWFibGUgdHlwZXMqKiwgZmluZCB3aGljaCB2YWx1ZXMgZWFjaCB2YXJpYWJsZSB0YWtlcyBhbmQgKipob3cgb2Z0ZW4qKiwgY2hlY2sgKipkaXN0cmlidXRpb25zKiogb2YgcXVhbnRpdGF0aXZlIHZhcmlhYmxlcywgZXhwbG9yZSAqKm1pc3NpbmcgdmFsdWVzKiouICDwn5OMIERPIE5PVCBkbyBhbnkgbW9kZWxpbmcgb3IgdHJhbnNmb3JtaW5nIG9mIGRhdGEgaW4gdGhpcyBzdGVwKOeOsOWcqOi/mOS4jeaYr+WBmuaVsOaNrui9rOaNoueahOaXtuWAmSkuICAKMi4gKipEYXRhIHNwbGl0dGluZyoqOiBTcGxpdCB0aGUgZGF0YSBpbnRvICoqdHJhaW5pbmcgYW5kIHRlc3Rpbmcgc2V0cyoqLiBUaGUgdGVzdGluZyBkYXRhc2V0IHdpbGwgbm90IGJlIHVzZWQgYWdhaW4gdW50aWwgdGhlIHZlcnkgZW5kLiAKMy4gKipEYXRhIHByZS1wcm9jZXNzaW5nKio6IE1vcmUgaW4tZGVwdGggZGF0YSBleHBsb3JhdGlvbiwgKipmZWF0dXJlIGVuZ2luZWVyaW5nKiosICoqdmFyaWFibGUgdHJhbnNmb3JtYXRpb25zKiouIFRoaXMgc3RlcCBpcyB1c3VhbGx5IHByZXR0eSB0aW1lLWNvbnN1bWluZy4gIAo0LiAqKkZpdHRpbmcgbW9kZWwocykqKjogRml0IHRoZSBtb2RlbHMgb2YgaW50ZXJlc3Qgb24gdGhlIHRyYWluaW5nIGRhdGEuICAKNS4gKipUdW5pbmcgcGFyYW1ldGVycyoqOiBJZiB0aGUgbW9kZWwgaW4gdGhlIHByZXZpb3VzIHN0ZXAgaW52b2x2ZWQgdHVuaW5nIHBhcmFtZXRlcnMsIHVzZSBjcm9zcy12YWxpZGF0aW9uIChvciBzaW1pbGFyIG1ldGhvZCkgdG8gZmluZCB0aGUgYmVzdCBwYXJhbWV0ZXIuICAKNi4gKipFdmFsdWF0ZSAmIGNvbXBhcmUgbW9kZWxzKio6IFVzZSBjcm9zcy12YWxpZGF0aW9uIHRvIGV2YWx1YXRlIHRoZSBtb2RlbC4gSWYgeW91IGhhdmUgYSBsYXJnZSBudW1iZXIgb2YgbW9kZWxzIHlvdSBhcmUgZXZhbHVhdGluZywgeW91IHdpbGwgcHJvYmFibHkgbGltaXQgdGhlIHNldCBvZiBtb2RlbHMgdG8geW91ciBiZXN0L2Zhdm9yaXRlIGZldyBkdXJpbmcgdGhpcyBzdGVwLiBUaGUgaW1hZ2UgYmVsb3cgaXMgdG8gaGVscCB5b3UgcmVtZW1iZXIgdGhhdCBwcm9jZXNzLCB3aGljaCBJIGhhdmUgYWxzbyB3cml0dGVuIGFib3V0IGJlbG93LgoKIVtpbWFnZS0yMDIxMDYyNDE0NDEzODIzNV0obWwtcmV2aWV3X2ltYWdlcy9pbWFnZS0yMDIxMDYyNDE0NDEzODIzNS5wbmcpCgogIC0gSW4gKiokayQtZm9sZCBjcm9zcy12YWxpZGF0aW9uKiosIHdlIGRpdmlkZSB0aGUgZGF0YSByYW5kb21seSBpbnRvICRrJCBhcHByb3hpbWF0ZWx5IGVxdWFsIGdyb3VwcyBvciAqZm9sZHMqLiBUaGUgc2NoZW1hdGljIGhlcmUgc2hvd3MgNS1mb2xkIGNyb3NzLXZhbGlkYXRpb24uICAKICAtIFRoZSBtb2RlbCBpcyBmaXQgb24gJGstMSQgb2YgdGhlIGZvbGRzIGFuZCB0aGUgcmVtYWluaW5nIGZvbGQgaXMgdXNlZCB0byBldmFsdWF0ZSB0aGUgbW9kZWwuIExldCdzIGxvb2sgYXQgdGhlIGZpcnN0IHJvdyBpbiB0aGUgc2NoZW1hdGljLiBIZXJlIHRoZSBtb2RlbCBpcyBmaXQgb24gdGhlIGRhdGEgdGhhdCBhcmUgaW4gZm9sZHMgMiwgMywgNCwgYW5kIDUuIFRoZSBtb2RlbCBpcyBldmFsdWF0ZWQgb24gdGhlIGRhdGEgaW4gZm9sZCAxLiAgCiAgLSAqKlJNU0UqKiBpcyBhIGNvbW1vbiBwZXJmb3JtYW5jZSBtZXRyaWMgZm9yIG1vZGVscyB3aXRoIGEgKipxdWFudGl0YXRpdmUgcmVzcG9uc2UqKi4gSXQgaXMgY29tcHV0ZWQgYnkgdGFraW5nIHRoZSBkaWZmZXJlbmNlIGJldHdlZW4gdGhlIHByZWRpY3RlZCBhbmQgYWN0dWFsIHJlc3BvbnNlIGZvciBlYWNoIG9ic2VydmF0aW9uLCBzcXVhcmluZyBpdCwgYW5kIHRha2luZyB0aGUgc3F1YXJlIHJvb3Qgb2YgdGhlIGF2ZXJhZ2Ugb3ZlciBhbGwgb2JzZXJ2YXRpb25zLiBPciwgYXMgYSBmb3JtdWxhOgoKJCQKUk1TRSA9IFxzcXJ0e1xmcmFjezF9e259XHN1bV97aT0xfV5uKHlfaSAtIFxoYXR7eX1faSleMn0sCiQkCgogIC0gU28sIGFnYWluIGxvb2tpbmcgYXQgdGhlIGZpcnN0IHJvdyBpbiB0aGUgc2NoZW1hdGljLCB0aGUgbW9kZWwgaXMgZml0IHRvIGZvbGRzIDIsIDMsIDQsIGFuZCA1IGFuZCB3ZSB3b3VsZCB1c2UgdGhhdCBtb2RlbCB0byBjb21wdXRlIHRoZSBSTVNFIGZvciBmb2xkIDEuIEluIHRoZSBzZWNvbmQgcm93LCB0aGUgbW9kZWwgaXMgZml0IHRvIHRoZSBkYXRhIGluIGZvbGRzIDEsIDMsIDQsIGFuZCA1IGFuZCB0aGF0IG1vZGVsIGlzIHVzZWQgdG8gY29tcHV0ZSB0aGUgUk1TRSBmb3IgdGhlIGRhdGEgaW4gdGhlIDJuZCBmb2xkLiAgCiAtIEFmdGVyIHRoaXMgaXMgZG9uZSBmb3IgYWxsIDUgZm9sZHMsIHdlIHRha2UgdGhlIGF2ZXJhZ2UgUk1TRSwgdG8gb2J0YWluIHRoZSBvdmVyYWxsIHBlcmZvcm1hbmNlLiBUaGlzIG92ZXJhbGwgZXJyb3IgaXMgc29tZXRpbWVzIGNhbGxlZCB0aGUgKipDViBlcnJvcioqLiBBdmVyYWdpbmcgdGhlIHBlcmZvcm1hbmNlIG92ZXIgJGskIGZvbGRzIGdpdmVzIGEgYmV0dGVyIGVzdGltYXRlIG9mIHRoZSB0cnVlIGVycm9yIHRoYW4gdXNpbmcgb25lIGhvbGQtb3V0IHNldC4gSXQgYWxzbyBhbGxvd3MgdXMgdG8gZXN0aW1hdGUgaXRzIHZhcmlhYmlsaXR5LgogLSBGb3IgbW9kZWxzIHdpdGggYSBjYXRlZ29yaWNhbCByZXNwb25zZSwgYSBjb21tb24gcGVyZm9ybWFuY2UgbWV0cmljIHRvIGV2YWx1YXRlIGEgbW9kZWwgaXMgYWNjdXJhY3k6IG91dCBvZiBhbGwgY2FzZXMsIHRoZSBmcmFjdGlvbiBvZiBjb3JyZWN0ICh0cnVlIHBvc2l0aXZlcyBhbmQgdHJ1ZSBuZWdhdGl2ZXMpIGNsYXNzaWZpY2F0aW9ucy4gQSBjcm9zcy12YWxpZGF0ZWQgYWNjdXJhY3kgd291bGQgYmUgY29tcHV0ZWQgaW4gYSBzaW1pbGFyIHdheSB0byB0aGUgY3Jvc3MtdmFsaWRhdGVkIFJNU0UgZGVzY3JpYmVkIGFib3ZlLgoKNy4gKipBcHBseSBmaW5hbCBmZXcgbW9kZWxzIHRvIHRlc3RpbmcgZGF0YSoqOiBBZnRlciB3ZSBsaW1pdCB0aGUgbnVtYmVyIG9mIG1vZGVscyB0byB0aGUgdG9wIGZldywgd2Ugd2lsbCB3YW50IHRvIHRvIGFwcGx5IGl0IHRvIHRoZSB0ZXN0aW5nIGRhdGEsIHRoZSBkYXRhIHRoYXQgaGFzbid0IGJlZW4gdXNlZCBhdCBhbGwgZHVyaW5nIHRoZSBtb2RlbGluZyBwcm9jZXNzLiBUaGlzIHdpbGwgZ2l2ZSB1cyBhIG1lYXN1cmUgb2YgdGhlIG1vZGVsJ3MgcGVyZm9ybWFuY2UgYW5kIG1heSBoZWxwIHVzIG1ha2UgYSBmaW5hbCBkZWNpc2lvbiBhYm91dCB3aGljaCBtb2RlbCB0byB1c2UuIAoKOC4gKipVc2UgdGhlIG1vZGVsIG9yIG1vZGVsIGRlcGxveSAhKio6IFRoaXMgc3RlcCBtYXkgYmUgc2ltcGxlLCBsaWtlIGFwcGx5aW5nIHRoZSBtb2RlbCB0byBhIHNpbmdsZSBzZXQgb2YgZGF0YSwgb3IgaXQgY291bGQgYmUgYSBsb3QgbW9yZSBjb21wbGV4LCByZXF1aXJpbmcgdGhlIG1vZGVsIHRvIGJlICJwdXQgaW50byBwcm9kdWN0aW9uIiBzbyBpdCBjYW4gYmUgKiphcHBsaWVkIHRvIG5ldyBkYXRhIGluIHJlYWwtdGltZSoqLgoKOS4gKipRdWVzdGlvbiB0aGUgZGF0YSBhbmQgbW9kZWwqKjogVGhpcyBpc24ndCByZWFsbHkgYSBzaW5nbGUgc3RlcCBidXQgc29tZXRoaW5nIHRoYXQgd2Ugc2hvdWxkIGJlIGRvaW5nIHRocm91Z2ggdGhlIG1vZGVsaW5nIHByb2Nlc3MuIFdlIHNob3VsZCBiZSB3b3JraW5nIGNsb3NlbHkgd2l0aCBwZW9wbGUgd2hvIGtub3cgdGhlIGRhdGEgd2VsbCBzbyB3ZSBhc3N1cmUgdGhhdCB3ZSBhcmUgKippbnRlcnByZXRpbmcgYW5kIHVzaW5nIGl0IGNvcnJlY3RseSoqLiBBbmQgd2Ugc2hvdWxkIGV2YWx1YXRlIGhvdyB0aGUgbW9kZWwgbWlnaHQgYmUgdXNlZCBpbiBuZXcgY29udGV4dHMsIGVzcGVjaWFsbHkga2VlcGluZyBpbiBtaW5kIGhvdyB0aGUgbW9kZWwgY291bGQgYmUgdXNlZCB0byBkbyBoYXJtLiAKCiMjIFVzaW5nIGB0aWR5bW9kZWxzYCBmb3IgdGhlIHByb2Nlc3MKCkluIHRoaXMgc2VjdGlvbiwgSSB3aWxsIHNob3cgaG93IHdlIGNhbiB1c2UgdGhlICoqdGlkeW1vZGVscyoqIGZyYW1ld29yayB0byBleGVjdXRlIHRoZSBtb2RlbGluZyBwcm9jZXNzLiBJJ3ZlIHVwZGF0ZWQgdGhlIGRpYWdyYW0gZnJvbSBhYm92ZSB0byBpbmNsdWRlIHNvbWUgb2YgdGhlIGxpYnJhcmllcyBhbmQgZnVuY3Rpb25zIHdlJ2xsIHVzZSB0aHJvdWdob3V0IHRoZSBwcm9jZXNzLiAKCjxjZW50ZXI+CgohW2ltYWdlLTIwMjEwNjI0MTQ0NTI1NzE4XShtbC1yZXZpZXdfaW1hZ2VzL2ltYWdlLTIwMjEwNjI0MTQ0NTI1NzE4LnBuZykKCiFbaW1hZ2UtMjAyMTA2MjQxNDU4MzIxMDddKG1sLXJldmlld19pbWFnZXMvaW1hZ2UtMjAyMTA2MjQxNDU4MzIxMDcucG5nKQoKCgo8L2NlbnRlcj4KCkZpcnN0LCBsZXQncyBsb2FkIHNvbWUgb2YgdGhlIGxpYnJhcmllcyB3ZSB3aWxsIHVzZToKCmBgYHtyIGxpYnJhcmllc30KbGlicmFyeSh0aWR5dmVyc2UpICAgICAgICAgIyBmb3IgcmVhZGluZyBpbiBkYXRhLCBncmFwaGluZywgYW5kIGNsZWFuaW5nCmxpYnJhcnkodGlkeW1vZGVscykgICAgICAgICMgZm9yIG1vZGVsaW5nIC4uLiB0aWRpbHkKbGlicmFyeShnbG1uZXQpICAgICAgICAgICAgIyBmb3IgcmVndWxhcml6ZWQgcmVncmVzc2lvbiwgaW5jbHVkaW5nIExBU1NPCmxpYnJhcnkobmFuaWFyKSAgICAgICAgICAgICMgZm9yIGV4YW1pbmluZyBtaXNzaW5nIHZhbHVlcyAoTkFzKQpsaWJyYXJ5KGx1YnJpZGF0ZSkgICAgICAgICAjIGZvciBkYXRlIG1hbmlwdWxhdGlvbgpsaWJyYXJ5KG1vZGVybmRpdmUpICAgICAgICAjIGZvciBLaW5nIENvdW50eSBob3VzaW5nIGRhdGEKbGlicmFyeSh2aXApICAgICAgICAgICAgICAgIyBmb3IgdmFyaWFibGUgaW1wb3J0YW5jZSBwbG90cwpsaWJyYXJ5KHJtYXJrZG93bikgICAgICAgICAjIGZvciBwYWdlZCB0YWJsZXMKdGhlbWVfc2V0KHRoZW1lX21pbmltYWwoKSkgIyBteSBmYXZvcml0ZSBnZ3Bsb3QyIHRoZW1lIDopCmBgYAoKUmVhZCBpbiB0aGUgS2luZyBDb3VudHkgSG91c2luZyBkYXRhIGFuZCB0YWtlIGEgbG9vayBhdCB0aGUgZmlyc3QgNSByb3dzLgoKYGBge3IgZGF0YX0KZGF0YSgiaG91c2VfcHJpY2VzIikKCmhvdXNlX3ByaWNlcyAlPiUgCiAgc2xpY2UoMTo1KQpgYGAKCk5vdywgd2Ugd2lsbCBkaWcgaW50byBlYWNoIG9mIHRoZSBtb2RlbGluZyBzdGVwcyBsaXN0ZWQgYWJvdmUuCgojIyMgMS4gUXVpY2sgZXhwbG9yYXRpb24KClRha2UgYSBxdWljayBsb29rIGF0IGRpc3RyaWJ1dGlvbnMgb2YgYWxsIHRoZSB2YXJpYWJsZXMgdG8gY2hlY2sgZm9yIGFueXRoaW5nIGlycmVndWxhci4gCgpRdWFudGl0YXRpdmUgdmFyaWFibGVzOgoKYGBge3IgZXhwbF9xdWFudCwgZmlnLndpZHRoPTYsIGZpZy5oZWlnaHQ9NH0KIyBob3VzZV9wcmljZXMgJT4lIAojICAgc2VsZWN0KHdoZXJlKGlzLm51bWVyaWMpKSAlPiUgCiMgICBwaXZvdF9sb25nZXIoY29scyA9IGV2ZXJ5dGhpbmcoKSwKIyAgICAgICAgICAgICAgICBuYW1lc190byA9ICJ2YXJpYWJsZSIsIAojICAgICAgICAgICAgICAgIHZhbHVlc190byA9ICJ2YWx1ZSIpICU+JSAKIyAgIGdncGxvdChhZXMoeCA9IHZhbHVlKSkgKwojICAgZ2VvbV9oaXN0b2dyYW0oYmlucyA9IDMwKSArCiMgICBmYWNldF93cmFwKHZhcnModmFyaWFibGUpLCAKIyAgICAgICAgICAgICAgc2NhbGVzID0gImZyZWUiKQoKaG91c2VfcHJpY2VzICU+JSAKICBzZWxlY3Qod2hlcmUoaXMubnVtZXJpYykpICU+JSAKICBEYXRhRXhwbG9yZXI6OnBsb3RfaGlzdG9ncmFtKHRoZW1lX2NvbmZpZyA9IHRoZW1lX21pbmltYWwoKSkKYGBgCgpUaGluZ3MgSSBub3RpY2VkIGFuZCBwcmUtcHJvY2Vzc2luZyB0aG91Z2h0czoKCiogUmlnaHQtc2tld25lc3MgaW4gYHByaWNlYCBhbmQgYWxsIHZhcmlhYmxlcyByZWdhcmRpbmcgc3F1YXJlIGZvb3RhZ2UgLS0+IGxvZyB0cmFuc2Zvcm0gaWYgdXNpbmcgbGluZWFyIHJlZ3Jlc3Npb24uCiogTWFueSAwJ3MgaW4gYHNxZnRfYmFzZW1lbnRgLCBgdmlld2AsIGFuZCBgeXJfcmVub3ZhdGVkYCAtLT4gY3JlYXRlIGluZGljYXRvciB2YXJpYWJsZXMgb2YgaGF2aW5nIHRoYXQgZmVhdHVyZSB2cy4gbm90LCBpZS4gYSB2YXJpYWJsZSBjYWxsZWQgYGJhc2VtZW50YCB3aGVyZSBhIGAwYCBpbmRpY2F0ZXMgbm8gYmFzZW1lbnQgKGBzcWZ0X2Jhc2VtZW50YCA9IDApIGFuZCBhIGAxYCBpbmRpY2F0ZXMgYSBiYXNlbWVudCAoYHNxZnRfYmFzZW1lbnRgID4gMCkuICAKKiBBZ2Ugb2YgaG9tZSBtYXkgYmUgYSBiZXR0ZXIsIG1vcmUgaW50ZXJwcmV0YWJsZSB2YXJpYWJsZSB0aGFuIHllYXIgYnVpbHQgLS0+IGBhZ2VfYXRfc2FsZSA9IHllYXIoZGF0ZSkgLSB5cl9idWlsdGAuCgo8aW1nIHNyYz0ibWwtcmV2aWV3X2ltYWdlcy9pbWFnZS0yMDIxMDYyNDE1MTUzODEzOS5wbmciIGFsdD0iaW1hZ2UtMjAyMTA2MjQxNTE1MzgxMzkiIHN0eWxlPSJ6b29tOjgwJTsiIC8+CgpDYXRlZ29yaWNhbCB2YXJpYWJsZXM6CgpgYGB7ciBleHBsX2NhdH0KIyBob3VzZV9wcmljZXMgJT4lIAojICAgc2VsZWN0KHdoZXJlKGlzLmZhY3RvcikpICU+JSAKIyAgIHBpdm90X2xvbmdlcihjb2xzID0gZXZlcnl0aGluZygpLAojICAgICAgICAgICAgICAgIG5hbWVzX3RvID0gInZhcmlhYmxlIiwgCiMgICAgICAgICAgICAgICAgdmFsdWVzX3RvID0gInZhbHVlIikgJT4lIAojICAgZ2dwbG90KGFlcyh4ID0gdmFsdWUpKSArCiMgICBnZW9tX2JhcigpICsKIyAgIGZhY2V0X3dyYXAodmFycyh2YXJpYWJsZSksIAojICAgICAgICAgICAgICBzY2FsZXMgPSAiZnJlZSIsIAojICAgICAgICAgICAgICBucm93ID0gMikKCmhvdXNlX3ByaWNlcyAlPiUKICBzZWxlY3Qod2hlcmUoaXMuZmFjdG9yKSkgJT4lCiAgRGF0YUV4cGxvcmVyOjpwbG90X2JhcigpCmBgYAoKVGhpbmdzIEkgbm90aWNlZCBhbmQgcHJlLXByb2Nlc3NpbmcgdGhvdWdodHM6CgoqIGBjb25kaXRpb25gIGFuZCBgZ3JhZGVgIGJvdGggaGF2ZSBsZXZlbHMgd2l0aCBsb3cgY291bnRzIC0tPiBtYWtlIGZld2VyIGNhdGVnb3JpZXMuICAo6L+Z5L+p5Y+Y6YeP5L2O6aKR546H55qE57G75Yir5pyJ5b6I5aSaLCDopoHnsr7nroDkuIDkuIspCiogYHppcGNvZGVgIGhhcyBtYW55IHVuaXF1ZSBsZXZlbHMgLS0+IGRvbid0IHVzZSB0aGF0IHZhcmlhYmxlIGZvciBub3cuICAo6L+Z5Liq5Z+65pys5LiK6YO95pivIHVuaXF1ZSDnmoTlgLwsIOS4jemAguWQiOeUqOWBmuWboOWtkOWPmOmHjykKKiBXZSBtaWdodCBjb25zaWRlciB1c2luZyB0aGUgKiptb250aCB0aGUgaG91c2Ugd2FzIHNvbGQqKiBhcyBhIHZhcmlhYmxlOgoKYGBge3J9CmhvdXNlX3ByaWNlcyAlPiUgCiAgY291bnQobW9udGggPSBtb250aChkYXRlLCBsYWJlbCA9IFRSVUUpKSAlPiUgCiAgZ2dwbG90KCkgKwogIGdlb21fY29sKGFlcyh4ID0gbW9udGgsIHkgPSBuKSkKYGBgCgoqIEFuZCwgd2UgcXVpY2tseSBsb29rIGF0IHRoZSBjb3VudHMgZm9yIHRoZSBgd2F0ZXJmcm9udGAgdmFyaWFibGUuIE5vdCBtYW55IGhvdXNlcyBhcmUgd2F0ZXJmcm9udCBwcm9wZXJ0aWVzLiAgCgpgYGB7cn0KaG91c2VfcHJpY2VzICU+JSAKICBjb3VudCh3YXRlcmZyb250KQpgYGAKCiogVGhlIG9ubHkgb3RoZXIgdmFyaWFibGUgaXMgYGlkYCB3aGljaCBpc24ndCB1c2VkIGluIG1vZGVsaW5nLgoKKiBCZWZvcmUgbW92aW5nIG9uLCBsZXQncyB1c2UgdGhlIGBhZGRfbl9taXNzKClgKOWvueihjOi/m+ihjOe8uuWkseWAvOiuoeeul+e7n+iuoSkgZnVuY3Rpb24gZnJvbSB0aGUgYG5hbmlhcmAgbGlicmFyeSB0byBzZWUgaWYgd2UgaGF2ZSBhbnkgbWlzc2luZyB2YWx1ZXMuIEFuZCBpdCBhcHBlYXJzIHRoYXQgdGhlcmUgYXJlbid0IGFueSBtaXNzaW5nIHZhbHVlcyAtIGx1Y2t5IHVzIQoKYGBge3J9CmhvdXNlX3ByaWNlcyAlPiUgCiAgYWRkX25fbWlzcygpICU+JSAKICBjb3VudChuX21pc3NfYWxsKQpgYGAKCgojIyMgMi4gRGF0YSBzcGxpdHRpbmcKCioqTk9URSoqOiBJIHN0YXJ0IGJ5IGRvaW5nIHNvbWUgbWFuaXB1bGF0aW5nIG9mIHRoZSBkYXRhc2V0IHRvIHVzZSBgbG9nX3ByaWNlYCBhcyB0aGUgcmVzcG9uc2UgdmFyaWFibGUgcmF0aGVyIHRoYW4gYHByaWNlYC4gSSBvcmlnaW5hbGx5IGRpZCB0aGlzIHVzaW5nIGEgYHN0ZXBfbG9nKClgIGZ1bmN0aW9uIGFmdGVyIGEgYHJlY2lwZSgpYCBmdW5jdGlvbiAoc2VlIHRoZSBuZXh0IHNlY3Rpb24pLCBidXQgcmVhZCBpbiB0aGlzIFtSU3R1ZGlvIENvbW11bml0eSBwb3N0XShodHRwczovL2NvbW11bml0eS5yc3R1ZGlvLmNvbS90L2ZpdC1yZXNhbXBsZXMtcHJlcC1hbmQtb3V0Y29tZS10cmFuc2Zvcm0tYmVoYXZpb3IvODM4OTEvMiksIGluIHRoZSBjb21tZW50IGJ5IE1heCBLdWhuLCB0aGF0ICoqaXQncyBiZXR0ZXIgdG8gdHJhbnNmb3JtIHRoZSBvdXRjb21lIGJlZm9yZSBkb2luZyB0aGUgbW9kZWxpbmcqKi4gVGhlcmUgaXMgYWxzbyBhIGRpc2N1c3Npb24gb2YgdGhpcyBpbiB0aGUgW1NraXBwaW5nIHN0ZXBzIGZvciBuZXcgZGF0YV0oaHR0cHM6Ly93d3cudG13ci5vcmcvcmVjaXBlcy5odG1sI3NraXAtZXF1YWxzLXRydWUpIHNlY3Rpb24gb2YgdGhlIEt1aG4gJiBTaWxnZSAqKipUaWR5IE1vZGVsaW5nIHdpdGggUiogYm9vayoqLgoKPiAKClRoZW4sIHdlIHNwbGl0IHRoZSBkYXRhIGludG86IHRyYWluaW5nICsgdGVzdGluZyBkYXRhc2V0cy4gCgpXZSB1c2UgdGhlIHRyYWluaW5nIGRhdGEgdG8gKipmaXQgZGlmZmVyZW50IHR5cGVzIG9mIG1vZGVscyoqIGFuZCAqKnRvIHR1bmUgcGFyYW1ldGVycyoqIG9mIHRob3NlIG1vZGVscyBpZiBuZWVkZWQsIGFuZCB0byBoZWxwIHVzIGNob29zZSBvdXIgYmVzdCBtb2RlbHMgKG9yIG1heWJlIGJlc3QgZmV3KS4gCgpUaGUgdGVzdGluZyBkYXRhc2V0IGlzIHNhdmVkIGZvciB0aGUgdmVyeSBlbmQgdG8gY29tcGFyZSBhIHNtYWxsIHN1YnNldCBvZiBtb2RlbHMgYW5kIHRvICoqZ2l2ZSBhbiBlc3RpbWF0ZSBvZiB0aGUgcGVyZm9ybWFuY2UqKiBvbiBkYXRhIHRoZSBtb2RlbCBoYXNuJ3Qgc2Vlbi4gCgpUaGUgYGluaXRpYWxfc3BsaXQoKWAgZnVuY3Rpb24gZnJvbSB0aGUgYHJzYW1wbGVgIGxpYnJhcnkgKHBhcnQgb2YgYHRpZHltb2RlbHNgKSBpcyB1c2VkIHRvIGNyZWF0ZSB0aGlzIHNwbGl0LiBXZSBqdXN0IGRvIHJhbmRvbSBzcGxpdHRpbmcgd2l0aCB0aGlzIGRhdGFzZXQsIGJ1dCB0aGVyZSBhcmUgb3RoZXIgYXJndW1lbnRzIHRoYXQgYWxsb3cgeW91IHRvIGRvICoqc3RyYXRpZmllZCBzYW1wbGluZyoqLiBUaGVuIHdlIHVzZSBgdHJhaW5pbmcoKWAgYW5kIGB0ZXN0aW5nKClgIHRvIGV4dHJhY3QgdGhlIHR3byBkYXRhc2V0cywgYGhvdXNlX3RyYWluaW5nYCBhbmQgYGhvdXNlX3Rlc3RpbmdgLiAKCmBgYHtyIGluaXRfc3BsaXR9CnNldC5zZWVkKDMyNykgI2ZvciByZXByb2R1Y2liaWxpdHkKCmhvdXNlX3ByaWNlcyA8LSBob3VzZV9wcmljZXMgJT4lIAogIG11dGF0ZShsb2dfcHJpY2UgPSBsb2cocHJpY2UsIGJhc2UgPSAxMCkpICU+JSAKICBzZWxlY3QoLXByaWNlKQoKIyBSYW5kb21seSBhc3NpZ25zIDc1JSBvZiB0aGUgZGF0YSB0byB0cmFpbmluZy4KaG91c2Vfc3BsaXQgPC0gaW5pdGlhbF9zcGxpdChob3VzZV9wcmljZXMsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3AgPSAuNzUpCmhvdXNlX3NwbGl0CiM8dHJhaW5pbmcvdGVzdGluZy90b3RhbD4KCmhvdXNlX3RyYWluaW5nIDwtIHRyYWluaW5nKGhvdXNlX3NwbGl0KQpob3VzZV90ZXN0aW5nIDwtIHRlc3RpbmcoaG91c2Vfc3BsaXQpCmBgYAoKIyMjIDMuIERhdGEgcHJlLXByb2Nlc3NpbmcKCioqVGhpcyBzdGVwIG1heSAgbm90IHNlZW0gdmVyeSB0aW1lIGNvbnN1bWluZyBpbiB0aGlzIGV4YW1wbGUqKiwgYnV0IHlvdSB3aWxsIG9mdGVuIGNvbWUgYmFjayB0byB0aGlzIHN0ZXAgYW5kIHNwZW5kIGEgbG90IG9mIHRpbWUgdHJ5aW5nIGRpZmZlcmVudCB2YXJpYWJsZSB0cmFuc2Zvcm1hdGlvbnMuIFlvdSBzaG91bGQgbWFrZSBzdXJlIHRvIHdvcmsgY2xvc2VseSB3aXRoIHRoZSBwZW9wbGUgd2hvIHVzZSBhbmQgY3JlYXRlIHRoZSBkYXRhIGR1cmluZyB0aGlzIHN0ZXAuIFRoZXkgYXJlIGEgY3J1Y2lhbCBwYXJ0IG9mIHRoZSBwcm9jZXNzLgoKKiBXZSB1c2UgdGhlIGByZWNpcGUoKWAgZnVuY3Rpb24gdG8gZGVmaW5lIHRoZSAqKnJlc3BvbnNlL291dGNvbWUgdmFyaWFibGUqKiBhbmQgdGhlICoqcHJlZGljdG9yIHZhcmlhYmxlcy4qKiAKCiogQSB2YXJpZXR5IG9mIGBzdGVwX3h4eCgpYCBmdW5jdGlvbnMgY2FuIGJlIHVzZWQgdG8gZG8gYW55IGRhdGEgKipwcmUtcHJvY2Vzc2luZy90cmFuc2Zvcm1pbmcqKi4gRmluZCB0aGVtIGFsbCBbaGVyZV0oaHR0cHM6Ly93d3cudGlkeW1vZGVscy5vcmcvZmluZC9yZWNpcGVzLykuIEkgdXNlZCBhIGZldywgd2l0aCBicmllZiBkZXNjcmlwdGlvbnMgaW4gdGhlIGNvZGUuIEkgYWxzbyB1c2VkIHNvbWUgc2VsZWN0b3IgZnVuY3Rpb25zLCBsaWtlIGBhbGxfcHJlZGljdG9ycygpYCBhbmQgYGFsbF9ub21pbmFsKClgIHRvIGhlbHAgbWUgc2VsZWN0IHRoZSByaWdodCB2YXJpYWJsZXMuIEZvciBzdWdnZXN0aW9ucyBvbiB3aGljaCBgc3RlcF94eHgoKWAgZnVuY3Rpb25zIHRvIHVzZSB3aXRoIHdoaWNoIGVuZ2luZXMsIHNlZSB0aGlzIGxpc3Qgb2YgZnVuY3Rpb25zIHdpdGggWyDwn5OMIGV4YW1wbGUgdGVtcGxhdGVzXShodHRwczovL3VzZW1vZGVscy50aWR5bW9kZWxzLm9yZy9yZWZlcmVuY2UvdGVtcGxhdGVzLmh0bWwjZXhhbXBsZXMpLiAoVGhhbmsgeW91IEFsaXNvbiBIaWxsLCBmb3Igc2hvd2luZyBtZSB0aGlzIHJlc291cmNlIHZpYSBbUiBTdHVkaW8gQ29tbXVuaXR5XShodHRwczovL2NvbW11bml0eS5yc3R1ZGlvLmNvbS90L3RpZHltb2RlbHMtbGFzc28tc2NhbGVkLXZhcmlhYmxlcy85OTI1NikuKQoKKiBPbmUgdGhpbmcgdGhhdCBpcyBkaWZmZXJlbnQgaGVyZSBmcm9tIHdoYXQgeW91IG1pZ2h0IGJlIHVzZWQgdG8gaXMgdGhhdCB3ZSBleHBsaWNpdGx5IG1ha2UgZHVtbXkgdmFyaWFibGVzIHdpdGggdGhlIGBzdGVwX2R1bW15KClgIGZ1bmN0aW9uLiAqKldlIGRvbid0IG5lZWQgdG8gYWx3YXlzIGRvIHRoYXQgLSBpdCBkZXBlbmRzIG9uIHRoZSBtb2RlbCB3ZSB1c2Uo5LiN5piv5omA5pyJ55qE5qih5Z6L6YO96KaB5rGC6L2s5o2i5ZOR5Y+Y6YePKSoqLiBUaGUgWyDwn5OMIHJlY29tbWVuZGVkIHByZXByb2Nlc3NpbmddKGh0dHBzOi8vd3d3LnRtd3Iub3JnL3ByZS1wcm9jLXRhYmxlLmh0bWwpIGFwcGVuZGl4IG9mIHRoZSAqVGlkeSBNb2RlbGluZyB3aXRoIFIqIGJvb2sgaXMgYSBnb29kIHBsYWNlIHRvIGxvb2sgZm9yIHJlZmVyZW5jZS4gIAoKKiBXZSBhbHNvIHVzZSBgc3RlcF9ub3JtYWxpemUoKWAgaGVyZSB0byAqKmNlbnRlciBhbmQgc2NhbGUqKiBvdXIgbnVtZXJpYyBwcmVkaWN0b3IgdmFyaWFibGVzLiBFdmVuIHRob3VnaCB0aGlzIGlzIHRoZSBkZWZhdWx0IGluIHRoZSBgZ2xtbmV0YCBlbmdpbmUgKHNlZSBuZXh0IHN0ZXApLCAg8J+UpSAgKip0aGlzIGlzIGltcG9ydGFudCB0byBlbnN1cmUgdGhhdCB0aGlzIHN0ZXAgaGFwcGVucyB3aXRoIG5ldyBkYXRhKiouCgoqIFRoZSBgdXBkYXRlX3JvbGVzKClgIGZ1bmN0aW9uIGlzIHVzZWQgdG8gY2hhbmdlIHRoZSAqKnJvbGVzIG9mIHNvbWUgdmFyaWFibGVzKiouIEZvciB1cywgdGhlc2UgYXJlIHZhcmlhYmxlcyB3ZSBtYXkgd2FudCB0byBpbmNsdWRlIGZvciBldmFsdWF0aW9uIHB1cnBvc2VzIGJ1dCB3aWxsIG5vdCBiZSB1c2VkIGluIGJ1aWxkaW5nIHRoZSBtb2RlbC4gSSBjaG9zZSB0aGUgcm9sZSBvZiBgZXZhbHVhdGl2ZWAgYnV0IHlvdSBjb3VsZCBuYW1lIHRoYXQgcm9sZSBhbnl0aGluZyB5b3Ugd2FudCwgZWcuIGBpZGAsIGBleHRyYWAsIGBqdW5rYCAobWF5YmUgYSBiYWQgaWRlYT8pLgoKYGBge3IgcmVjaXBlfQpob3VzZV9yZWNpcGUgPC0gcmVjaXBlKGxvZ19wcmljZSB+IC4sICNzaG9ydC1jdXQsIC4gPSBhbGwgb3RoZXIgdmFycwogICAgICAgICAgICAgICAgICAgICAgIGRhdGEgPSBob3VzZV90cmFpbmluZykgJT4lIAogICMgUHJlLXByb2Nlc3Npbmc6CiAgIyBSZW1vdmUsIHJlZHVuZGFudCB0byBzcWZ0X2xpdmluZyBhbmQgc3FmdF9sb3QKICBzdGVwX3JtKHNxZnRfbGl2aW5nMTUsIHNxZnRfbG90MTUpICU+JQogICMgbG9nIHNxZnQgdmFyaWFibGVzICh3aXRob3V0IHByaWNlKQogIHN0ZXBfbG9nKHN0YXJ0c193aXRoKCJzcWZ0IiksCiAgICAgICAgICAgLXNxZnRfYmFzZW1lbnQsIAogICAgICAgICAgIGJhc2UgPSAxMCkgJT4lIAogICMgSSBvcmlnaW5hbGx5IGhhZCB0aGUgc3RlcF9sb2coKSBmdW5jdGlvbiBiZWxvdwogICMgYnV0IGluc3RlYWQgZGlkIHRoZSB0cmFuc2Zvcm1hdGlvbiBiZWZvcmUKICAjIHRoZSByZWNpcGUgYmVjYXVzZSB0aGlzIHdpbGwgbWVzcyB1cCB0aGUgCiAgIyBwcmVkaWN0KCkgZnVuY3Rpb24KICAjIHN0ZXBfbG9nKHByaWNlLCBiYXNlID0gMTApICU+JSAKICAjIPCfk53lnKggcmVjaXBlcyDlvIDlp4vkuYvliY0sIOWvuSBZIOi/m+ihjCBzdGVwX2xvZyDov5nmoLflr7kgcHJlZGljdCgpIGZ1bmN0aW9uCiAgIyDnmoTpooTmtYvlgLzkuI3kvJrpgKDmiJDlubLmibAKICAKICAjIG5ldyBncmFkZSB2YXJpYWJsZSBjb21iaW5lcyBsb3cgZ3JhZGVzICYgaGlnaCBncmFkZXMKICAjIGluZGljYXRvciB2YXJpYWJsZXMgZm9yIGJhc2VtZW50LCByZW5vdmF0ZSwgYW5kIHZpZXcgCiAgIyB3YXRlcmZyb250IHRvIG51bWVyaWMKICAjIGFnZSBvZiBob3VzZQogIHN0ZXBfbXV0YXRlKGdyYWRlID0gYXMuY2hhcmFjdGVyKGdyYWRlKSwKICAgICAgICAgICAgICBncmFkZSA9IGZjdF9yZWxldmVsKAogICAgICAgICAgICAgICAgICAgICAgICBjYXNlX3doZW4oCiAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGUgJWluJSAiMSI6IjYiICAgfiAiYmVsb3dfYXZlcmFnZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGUgJWluJSAiMTAiOiIxMyIgfiAiaGlnaCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgVFJVRSB+IGdyYWRlCiAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgICAgICJiZWxvd19hdmVyYWdlIiwiNyIsIjgiLCI5IiwiaGlnaCIpLAogICAgICAgICAgICAgIGJhc2VtZW50ID0gYXMubnVtZXJpYyhzcWZ0X2Jhc2VtZW50ID09IDApLAogICAgICAgICAgICAgIHJlbm92YXRlZCA9IGFzLm51bWVyaWMoeXJfcmVub3ZhdGVkID09IDApLAogICAgICAgICAgICAgIHZpZXcgPSBhcy5udW1lcmljKHZpZXcgPT0gMCksCiAgICAgICAgICAgICAgd2F0ZXJmcm9udCA9IGFzLm51bWVyaWMod2F0ZXJmcm9udCksCiAgICAgICAgICAgICAgYWdlX2F0X3NhbGUgPSB5ZWFyKGRhdGUpIC0geXJfYnVpbHQpJT4lIAogICMgUmVtb3ZlIHNxZnRfYmFzZW1lbnQsIHlyX3Jlbm92YXRlZCwgYW5kIHlyX2J1aWx0CiAgc3RlcF9ybShzcWZ0X2Jhc2VtZW50LCAKICAgICAgICAgIHlyX3Jlbm92YXRlZCwgCiAgICAgICAgICB5cl9idWlsdCkgJT4lIAogICMgQ3JlYXRlIGEgbW9udGggdmFyaWFibGUKICBzdGVwX2RhdGUoZGF0ZSwgCiAgICAgICAgICAgIGZlYXR1cmVzID0gIm1vbnRoIikgJT4lIAogICMgTWFrZSB0aGVzZSBldmFsdWF0aXZlIHZhcmlhYmxlcywgbm90IGluY2x1ZGVkIGluIG1vZGVsaW5nCiAgdXBkYXRlX3JvbGUoYWxsX29mKGMoImlkIiwKICAgICAgICAgICAgICAgICAgICAgICAiZGF0ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgInppcGNvZGUiLCAKICAgICAgICAgICAgICAgICAgICAgICAibGF0IiwgCiAgICAgICAgICAgICAgICAgICAgICAgImxvbmciKSksCiAgICAgICAgICAgICAgbmV3X3JvbGUgPSAiZXZhbHVhdGl2ZSIpICU+JSAKICAjIENyZWF0ZSBpbmRpY2F0b3IgdmFyaWFibGVzIGZvciBmYWN0b3JzL2NoYXJhY3Rlci9ub21pbmFsCiAgIyBleHBsaWNpdGx5IHJlbW92ZSBvdXRjb21lLCBldmVuIHRob3VnaCBvdXRjb21lIGlzbid0IG5vbWluYWwKICAjIHRoaXMgaXMgaW1wb3J0YW50IGluIGNhc2VzIHdoZW4gd2UgaGF2ZSBhIG5vbWluYWwgb3V0cHV0IChlZy4gbG9naXN0aWMpCiAgc3RlcF9kdW1teShhbGxfbm9taW5hbCgpLCAKICAgICAgICAgICAgIC1hbGxfb3V0Y29tZXMoKSwgCiAgICAgICAgICAgICAtaGFzX3JvbGUobWF0Y2ggPSAiZXZhbHVhdGl2ZSIpKSAlPiUgCiAgc3RlcF9ub3JtYWxpemUoYWxsX3ByZWRpY3RvcnMoKSwgCiAgICAgICAgICAgICAgICAgLWFsbF9ub21pbmFsKCkpCmBgYAoKQXBwbHkgdG8gdHJhaW5pbmcgZGF0YXNldCwganVzdCB0byBzZWUgd2hhdCBoYXBwZW5zLiBUaGlzIGlzIG5vdCBhIG5lY2Vzc2FyeSBzdGVwLCAg8J+TnSBidXQgKipJIG9mdGVuIGxpa2UgdG8gY2hlY2sgdG8gc2VlIHRoYXQgZXZlcnl0aGluZyBpcyBhcyBleHBlY3RlZCoqLiAKCkZvciBleGFtcGxlLCBub3RpY2UgdGhlIG5hbWVzIG9mIHRoZSB2YXJpYWJsZXMgYXJlIHRoZSBzYW1lIGFzIGJlZm9yZSBidXQgdGhleSBoYXZlIGJlZW4gdHJhbnNmb3JtZWQsIGVnLiBgc3FmdF9saXZpbmdgIGlzIGFjdHVhbGx5IGxvZyBiYXNlIDEwIG9mIHNxdWFyZSBmZWV0IG9mIGxpdmluZy4gVGhpcyBjb25mdXNlZCBtZSB0aGUgZmlyc3QgdGltZSwgc28gSSB3YXMgZ2xhZCBJIHJhbiB0aGlzIGV4dHJhIHN0ZXAuIEJldHRlciB0byBiZSBjb25mdXNlZCBub3cgdGhhbiBsYXRlciBpbiB0aGUgcHJvY2VzcyBgciBlbW86OmppKCJncmlubmluZ19mYWNlIilgLgoKYGBge3IgYXBwbHlfcmVjaXBlfQp0cmFpbmluZ19kYXRhX3ByZXBhcmVkIDwtIApob3VzZV9yZWNpcGUgJT4lIAogIHByZXAoaG91c2VfdHJhaW5pbmcpICU+JQogICMgdXNpbmcgYmFrZShuZXdfZGF0YSA9IE5VTEwpIGdpdmVzIHNhbWUgcmVzdWx0IGFzIGp1aWNlKCkKICAjIGJha2UobmV3X2RhdGEgPSBOVUxMKQogIGp1aWNlKCkgCgp0cmFpbmluZ19kYXRhX3ByZXBhcmVkICU+JSAKICBwbG90X2hpc3RvZ3JhbSgpCmBgYAoKIyMjIDQuIEZpdHRpbmcgbW9kZWwocykKCk5vdyB0aGF0IHdlIGhhdmUgc3BsaXQgYW5kIHByZS1wcm9jZXNzZWQgdGhlIGRhdGEsIHdlIGFyZSByZWFkeSB0byBtb2RlbCEgRmlyc3QsIHdlIHdpbGwgbW9kZWwgYGxvZ19wcmljZWAgdXNpbmcgc2ltcGxlIGxpbmVhciByZWdyZXNzaW9uLgoKV2Ugd2lsbCBkbyB0aGlzIHVzaW5nIHNvbWUgbW9kZWxpbmcgZnVuY3Rpb25zIGZyb20gdGhlIGBwYXJzbmlwYCBwYWNrYWdlLiBGaW5kIGFsbCBhdmFpbGFibGUgZnVuY3Rpb25zIFsg8J+UjUV4cGxvcmUgdGlkeW1vZGVscyAtIFNlYXJjaCBwYXJzbmlwIG1vZGVsc10oaHR0cHM6Ly93d3cudGlkeW1vZGVscy5vcmcvZmluZC9wYXJzbmlwLykuIFsg8J+TnSBIZXJlXShodHRwczovL3BhcnNuaXAudGlkeW1vZGVscy5vcmcvcmVmZXJlbmNlL2xpbmVhcl9yZWcuaHRtbCkgaXMgdGhlIGRldGFpbCBmb3IgbGluZWFyIHJlZ3Jlc3Npb24uCgpJbiBvcmRlciB0byBkZWZpbmUgb3VyIG1vZGVsLCB3ZSBuZWVkIHRvIGRvIHRoZXNlIHN0ZXBzOgoKKiAqKkRlZmluZSB0aGUgbW9kZWwgdHlwZSoqLCB3aGljaCBpcyB0aGUgZ2VuZXJhbCB0eXBlIG9mIG1vZGVsIHlvdSB3YW50IHRvIGZpdCjpgInnnYDmqKHlnospLiAgICAKKiAqKlNldCB0aGUgZW5naW5lKiosIHdoaWNoIGRlZmluZXMgdGhlIHBhY2thZ2UvZnVuY3Rpb24gdGhhdCB3aWxsIGJlIHVzZWQgdG8gZml0IHRoZSBtb2RlbCjpgInnnYDkvb/nlKjlk6rkuKog8J+TpikuICAKKiAqKlNldCB0aGUgbW9kZSoqLCB3aGljaCBpcyBlaXRoZXIgIioqcmVncmVzc2lvbioqIiBmb3IgY29udGludW91cyByZXNwb25zZSB2YXJpYWJsZXMgb3IgIioqY2xhc3NpZmljYXRpb24qKiIgZm9yIGJpbmFyeS9jYXRlZ29yaWNhbCByZXNwb25zZSB2YXJpYWJsZXMuIChOb3RlIHRoYXQgZm9yIGxpbmVhciByZWdyZXNzaW9uLCBpdCBjYW4gb25seSBiZSAicmVncmVzc2lvbiIsIHNvIHdlIGRvbid0IE5FRUQgdGhpcyBzdGVwIGluIHRoaXMgY2FzZS4pICDpgZfmhr7nmoTmmK8sIOebruWJjeW5tuS4jeWMheWQq+aDs+eUn+WtmOWIhuaekOi/meenjeWMheWQq+aXtumXtOeahOexu+WeiwoqIChPUFRJT05BTCkgU2V0IGFyZ3VtZW50cyB0byB0dW5lLiBXZSdsbCBzZWUgYW4gZXhhbXBsZSBvZiB0aGlzIGxhdGVyLgoKYGBge3IgbGluZWFyX21vZH0KaG91c2VfbGluZWFyX21vZCA8LSAKICAjIERlZmluZSBhIGxpbmVhciByZWdyZXNzaW9uIG1vZGVsCiAgbGluZWFyX3JlZygpICU+JSAKICAjIFNldCB0aGUgZW5naW5lIHRvICJsbSIgKGxtKCkgZnVuY3Rpb24gaXMgdXNlZCB0byBmaXQgbW9kZWwpCiAgc2V0X2VuZ2luZSgibG0iKSAlPiUgCiAgIyBOb3QgbmVjZXNzYXJ5IGhlcmUsIGJ1dCBnb29kIHRvIHJlbWVtYmVyIGZvciBvdGhlciBtb2RlbHMKICBzZXRfbW9kZSgicmVncmVzc2lvbiIpCgpob3VzZV9saW5lYXJfbW9kCmBgYAoKVGhpcyBpcyBqdXN0IHNldHRpbmcgdXAgdGhlIHByb2Nlc3MuIFdlIGhhdmVuJ3QgZml0IHRoZSBtb2RlbCB0byBkYXRhIHlldCwgYW5kIHRoZXJlJ3Mgc3RpbGwgb25lIG1vcmUgc3RlcCBiZWZvcmUgd2UgZG8gLSBjcmVhdGluZyBhICoqd29ya2Zsb3cqKiEgVGhpcyBjb21iaW5lcyB0aGUgcHJlcHJvY2Vzc2luZyBhbmQgbW9kZWwgZGVmaW5pdGlvbiBzdGVwcy4KCmBgYHtyIHdvcmtmbG93fQpob3VzZV9sbV93ZiA8LSAKICAjIFNldCB1cCB0aGUgd29ya2Zsb3cKICB3b3JrZmxvdygpICU+JSAKICAjIEFkZCB0aGUgcmVjaXBlCiAgYWRkX3JlY2lwZShob3VzZV9yZWNpcGUpICU+JSAKICAjIEFkZCB0aGUgbW9kZWxpbmcKICBhZGRfbW9kZWwoaG91c2VfbGluZWFyX21vZCkKIyDov5nph4zmnInngrnlg4/mmK8gc2Npa2l0LWxlYXJuIOmHjOmdoueahOWIm+W7uuaooeWei+WvueixoSwg5Y+q5piv6L+Z5Liq5YyF5ZCr5LqGIHJhd2RhdGEgaW5wdXQg4p6hIGRhdGEgcHJvY2Vzc2luZyAg4p6hICByZWFkeSB0byBmaXQgZGF0YQpob3VzZV9sbV93ZgpgYGAKCk5vdyB3ZSBhcmUgZmluYWxseSByZWFkeSB0byBmaXQgdGhlIG1vZGVsISBBZnRlciBhbGwgdGhhdCB3b3JrLCB0aGlzIHBhcnQgc2VlbXMgZWFzeS4gV2UgZmlyc3QgdXNlIHRoZSBgZml0KClgIGZ1bmN0aW9uIHRvIGZpdCB0aGUgbW9kZWwsIHRlbGxpbmcgaXQgKip3aGljaCBkYXRhIHNldCB3ZSB3YW50IHRvIGZpdCB0aGUgbW9kZWwgdG8qKi4gVGhlbiB3ZSB1c2Ugc29tZSBvdGhlciBmdW5jdGlvbnMgdG8gZGlzcGxheSB0aGUgcmVzdWx0cyBuaWNlbHkuCgpgYGB7ciBmaXRfbG19CmhvdXNlX2xtX2ZpdCA8LSAKICAjIFRlbGwgaXQgdGhlIHdvcmtmbG93CiAgaG91c2VfbG1fd2YgJT4lIAogICMgRml0IHRoZSBtb2RlbCB0byB0aGUgdHJhaW5pbmcgZGF0YQogIGZpdChob3VzZV90cmFpbmluZykKCiMgRGlzcGxheSB0aGUgcmVzdWx0cyBuaWNlbHkKaG91c2VfbG1fZml0ICU+JSAKICBwdWxsX3dvcmtmbG93X2ZpdCgpICU+JSAKICB0aWR5KCkgJT4lIAogIG11dGF0ZShhY3Jvc3Mod2hlcmUoaXMubnVtZXJpYyksIH5yb3VuZCgueCwzKSkpIApgYGAKCgojIyMgNi4gRXZhbHVhdGUgJiBjb21wYXJlIG1vZGVscwoKKEkgcmVhbGl6ZSB3ZSBza2lwcGVkICM1LiBEb24ndCB3b3JyeSwgd2UnbGwgZ2V0IHRvIGl0LikKClRvIGV2YWx1YXRlIHRoZSBtb2RlbCwgd2Ugd2lsbCB1c2UgY3Jvc3MtdmFsaWRhdGlvbiAoQ1YpLCBzcGVjaWZpY2FsbHkgNS1mb2xkIENWLgoKIEZpcnN0LCB3ZSBzZXQgdXAgdGhlIGZpdmUgZm9sZHMgb2YgdGhlIHRyYWluaW5nIGRhdGEgdXNpbmcgdGhlIGB2Zm9sZF9jdigpYCBmdW5jdGlvbi4gCgpgYGB7ciBjdn0Kc2V0LnNlZWQoMTIxMSkgIyBmb3IgcmVwcm9kdWNpYmlsaXR5CmhvdXNlX2N2IDwtIHZmb2xkX2N2KGhvdXNlX3RyYWluaW5nLCB2ID0gNSkKYGBgCgpUaGVuLCB3ZSBmaXQgdGhlIG1vZGVsIHVzaW5nIHRoZSA1LWZvbGQgZGF0YXNldCB3ZSBqdXN0IGNyZWF0ZWQgKFdoZW4gSSBmaXJzdCBkaWQgdGhpcywgSSB0aG91Z2h0IEkgd291bGRuJ3QgaGF2ZSB0byBkbyBib3RoIHRoZSBwcmV2aW91cyBzdGVwIG9mIGZpdHRpbmcgYSBtb2RlbCBvbiB0aGUgdHJhaW5pbmcgZGF0YSBBTkQgdGhpcyBzdGVwLCBidXQgSSBjb3VsZG4ndCBmaWd1cmUgb3V0IGhvdyB0byBleHRyYWN0IHRoZSBmaW5hbCBtb2RlbCBmcm9tIHRoZSBDViBkYXRhIC4uLiBzbyB0aGlzIHdhcyBteSBzb2x1dGlvbiBhdCB0aGUgdGltZSAuLi4gYW5kIGl0IHR1cm5zIG91dCB5b3UgRE8gbmVlZCB0byBkbyBib3RoIGFzIG5vdGVkIGJ5IEp1bGlhIFNpbGdlIGluIHRoaXMgWyDwn5OMIHRpZHltb2RlbHM6IGZhc3Rlc3Qgd2F5IHRvIGV4dHJhY3QgYSBtb2RlbCBvYmplY3QgZnJvbSBmaXRfcmVzYW1wbGVzKCkgcmVzdWx0cyAtIE1hY2hpbmUgTGVhcm5pbmcgYW5kIE1vZGVsaW5nIC0gUlN0dWRpbyBDb21tdW5pdHldKGh0dHBzOi8vY29tbXVuaXR5LnJzdHVkaW8uY29tL3QvdGlkeW1vZGVscy1mYXN0ZXN0LXdheS10by1leHRyYWN0LWEtbW9kZWwtb2JqZWN0LWZyb20tZml0LXJlc2FtcGxlcy1yZXN1bHRzLzczMzAxLzMpLgoKYGBge3IgZml0X21vZGVsX2N2fQpzZXQuc2VlZCg0NTYpICMgRm9yIHJlcHJvZHVjaWJpbGl0eSAtIG5vdCBuZWVkZWQgZm9yIHRoaXMgYWxnb3JpdGhtCgpob3VzZV9sbV9maXRfY3YgPC0KICAjIFRlbGwgaXQgdGhlIHdvcmtmbG93CiAgaG91c2VfbG1fd2YgJT4lIAogICMg8J+TnSAgRml0IHRoZSBtb2RlbCAodXNpbmcgdGhlIHdvcmtmbG93KSB0byB0aGUgY3YgZGF0YTogZml0X3Jlc2FtcGxlcyAKICBmaXRfcmVzYW1wbGVzKGhvdXNlX2N2KQoKIyBUaGUgZXZhbHVhdGlvbiBtZXRyaWNzIGZvciBlYWNoIGZvbGQ6CmhvdXNlX2xtX2ZpdF9jdiAlPiUgCiAgc2VsZWN0KGlkLCAubWV0cmljcykgJT4lIAogIHVubmVzdCgubWV0cmljcykgCgojIEV2YWx1YXRpb24gbWV0cmljcyBhdmVyYWdlZCBvdmVyIGFsbCBmb2xkczoKY29sbGVjdF9tZXRyaWNzKGhvdXNlX2xtX2ZpdF9jdikKCiMgSnVzdCB0byBzaG93IHlvdSB3aGVyZSB0aGUgYXZlcmFnZXMgY29tZSBmcm9tOgpob3VzZV9sbV9maXRfY3YgJT4lIAogIHNlbGVjdChpZCwgLm1ldHJpY3MpICU+JSAKICB1bm5lc3QoLm1ldHJpY3MpICU+JSAKICBncm91cF9ieSgubWV0cmljLCAuZXN0aW1hdG9yKSAlPiUgCiAgc3VtbWFyaXplKG1lYW4gPSBtZWFuKC5lc3RpbWF0ZSksCiAgICAgICAgICAgIG4gPSBuKCksCiAgICAgICAgICAgIHN0ZF9lcnIgPSBzZCguZXN0aW1hdGUpL3NxcnQobikpCmBgYAoKIyMjIDcuIEFwcGx5IG1vZGVsIHRvIHRlc3RpbmcgZGF0YQoKSW4gdGhpcyBzaW1wbGUgc2NlbmFyaW8sIHdlIG1heSBiZSBpbnRlcmVzdGVkIGluIHNlZWluZyAqKmhvdyB0aGUgbW9kZWwgcGVyZm9ybXMgb24gdGhlIHRlc3RpbmcgZGF0YSoqIHRoYXQgd2FzIGxlZnQgb3V0LiBUaGUgY29kZSBiZWxvdyB3aWxsIGZpdCB0aGUgbW9kZWwgdG8gdGhlIHRyYWluaW5nIGRhdGEgYW5kIGFwcGx5IGl0IHRvIHRoZSB0ZXN0aW5nIGRhdGEuIFRoZXJlIGFyZSBvdGhlciB3YXlzIHdlIGNvdWxkIGhhdmUgZG9uZSB0aGlzLCBidXQgdGhlIHdheSB3ZSBkbyBpdCBoZXJlIHdpbGwgYmUgdXNlZnVsIHdoZW4gd2Ugc3RhcnQgdXNpbmcgbW9yZSBjb21wbGV4IG1vZGVscyB3aGVyZSB3ZSBuZWVkIHRvIHR1bmUgbW9kZWwgcGFyYW1ldGVycy4KCkFmdGVyIHRoZSBtb2RlbCBpcyBmaXQgYW5kIGFwcGxpZWQsIHdlIGNvbGxlY3QgdGhlIHBlcmZvcm1hbmNlIG1ldHJpY3MgYW5kIGRpc3BsYXkgdGhlbSBhbmQgc2hvdyB0aGUgcHJlZGljdGlvbnMgZnJvbSB0aGUgdGVzdGluZyBkYXRhLiBOb3RpY2UgdGhlIHRoZSBSTVNFIGhlcmUgaXMgdmVyeSBzaW1pbGFyIHRvIHRoZSBjcm9zcy12YWxpZGF0ZWQgUk1TRSB3ZSBjb21wdXRlZCBpbiB0aGUgcHJldmlvdXMgc3RlcC4gCgpgYGB7ciBmaXRfdGVzdH0KaG91c2VfbG1fdGVzdCA8LSAKICAjIFRoZSBtb2RlbGluZyB3b3JrIGZsb3cKICBob3VzZV9sbV93ZiAlPiUgCiAgIyBVc2UgdHJhaW5pbmcgZGF0YSB0byBmaXQgdGhlIG1vZGVsIGFuZCBhcHBseSBpdCB0byB0ZXN0aW5nIGRhdGEKICBsYXN0X2ZpdChob3VzZV9zcGxpdCkKCiMgcGVyZm9ybWFuY2UgbWV0cmljcyBmcm9tIHRlc3RpbmcgZGF0YQpjb2xsZWN0X21ldHJpY3MoaG91c2VfbG1fdGVzdCkKCiMgcHJlZGljdGlvbnMgZnJvbSB0ZXN0aW5nIGRhdGEKY29sbGVjdF9wcmVkaWN0aW9ucyhob3VzZV9sbV90ZXN0KSAKYGBgCgpUaGUgY29kZSBiZWxvdyBjcmVhdGVzIGEgc2ltcGxlIHBsb3QgdG8gZXhhbWluZSBwcmVkaWN0ZWQgdnMuIGFjdHVhbCBwcmljZSAobG9nIGJhc2UgMTApIGZyb20gdGhlIGhvdXNlIGRhdGEuIAoKYGBge3IgYWN0X3ByZWRfcGxvdH0KY29sbGVjdF9wcmVkaWN0aW9ucyhob3VzZV9sbV90ZXN0KSAlPiUgCiAgZ2dwbG90KGFlcyh4ID0gbG9nX3ByaWNlLCAKICAgICAgICAgICAgIHkgPSAucHJlZCkpICsKICBnZW9tX3BvaW50KGFscGhhID0gLjUsIAogICAgICAgICAgICAgc2l6ZSA9IC41KSArCiAgZ2VvbV9zbW9vdGgoc2UgPSBGQUxTRSkgKwogIGdlb21fYWJsaW5lKHNsb3BlID0gMSwgCiAgICAgICAgICAgICAgaW50ZXJjZXB0ID0gMCwgCiAgICAgICAgICAgICAgY29sb3IgPSAiZGFya3JlZCIpICsKICBsYWJzKHggPSAiQWN0dWFsIGxvZyhwcmljZSkiLCAKICAgICAgIHkgPSAiUHJlZGljdGVkIGxvZyhwcmljZSkiKQpgYGAKCkhlcmUgaXMgdGhlIHNhbWUgcGxvdCB1c2luZyB0aGUgKipyZWd1bGFyIHByaWNlIHNjYWxlKOS9v+eUqCBZIOeahOecn+WunuWAvCwg6ICM6Z2e6L2s5o2i5ZCO55qE5YC8KSoqLgoKYGBge3IgcHJpY2VfcHJlZF9wbG90fQpjb2xsZWN0X3ByZWRpY3Rpb25zKGhvdXNlX2xtX3Rlc3QpICU+JSAKICBnZ3Bsb3QoYWVzKHggPSAxMF5sb2dfcHJpY2UsIAogICAgICAgICAgICAgeSA9IDEwXi5wcmVkKSkgKwogIGdlb21fcG9pbnQoYWxwaGEgPSAuNSwgCiAgICAgICAgICAgICBzaXplID0gLjUpICsKICBnZW9tX3Ntb290aChzZSA9IEZBTFNFKSArCiAgZ2VvbV9hYmxpbmUoc2xvcGUgPSAxLCAKICAgICAgICAgICAgICBpbnRlcmNlcHQgPSAwLCAKICAgICAgICAgICAgICBjb2xvciA9ICJkYXJrcmVkIikgKwogIGxhYnMoeCA9ICJBY3R1YWwgcHJpY2UiLCAKICAgICAgIHkgPSAiUHJlZGljdGVkIHByaWNlIikgKwogIHNjYWxlX3hfY29udGludW91cyhsYWJlbHMgPSBzY2FsZXM6OmRvbGxhcl9mb3JtYXQoc2NhbGUgPSAuMDAwMDAxLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1ZmZpeCA9ICJNIikpICsKICBzY2FsZV95X2NvbnRpbnVvdXMobGFiZWxzID0gc2NhbGVzOjpkb2xsYXJfZm9ybWF0KHNjYWxlID0gLjAwMDAwMSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWZmaXggPSAiTSIpKQoKYGBgCgojIyMgOS4gUXVlc3Rpb24gdGhlIGRhdGEgYW5kIG1vZGVsCgooV2UnbGwgZ28gYmFjayB0byBzdGVwICM4IGluIGEgbW9tZW50KQoKV2hlbiB3ZSB1c2UgY3JlYXRlIG1vZGVscywgKippdCBpcyBpbXBvcnRhbnQgdG8gdGhpbmsgYWJvdXQgaG93IHRoZSBtb2RlbCB3aWxsIGJlIHVzZWQgYW5kIHNwZWNpZmljYWxseSBob3cgdGhlIG1vZGVsIGNvdWxkIGRvIGhhcm0qKi4gT25lIHRoaW5nIHRvIG5vdGljZSBpbiB0aGUgZ3JhcGhzIGFib3ZlL2JlbG93IGlzIHRoYXQgdGhlIHByaWNlIG9mICoqbG93ZXIgcHJpY2VkIGhvbWVzOiDpq5jkvLAqKiBhcmUsIG9uIGF2ZXJhZ2UsIG92ZXJlc3RpbWF0ZWQgd2hlcmVhcyB0aGUgcHJpY2Ugb2YgKipoaWdoZXIgcHJpY2VkIGhvbWVzOiDkvY7kvLAqKiBhcmUsIG9uIGF2ZXJhZ2UsIHVuZGVyZXN0aW1hdGVkLiAKCjxpbWcgc3JjPSJtbC1yZXZpZXdfaW1hZ2VzL2ltYWdlLTIwMjEwNjI0MTYyOTQxMTkzLnBuZyIgYWx0PSJpbWFnZS0yMDIxMDYyNDE2Mjk0MTE5MyIgc3R5bGU9Inpvb206MzAlOyIgLz4KCldoYXQgaWYgdGhpcyBtb2RlbCB3YXMgdXNlZCB0byBkZXRlcm1pbmUgdGhlIHByaWNlIG9mIGhvbWVzIGZvciBwcm9wZXJ0eSB0YXggcHVycG9zZXM/IFRoZW4gbG93ZXIgcHJpY2VkIGhvbWVzIHdvdWxkIGJlIG92ZXJ0YXhlZCB3aGlsZSBoaWdoZXIgcHJpY2VkIGhvbWVzIHdvdWxkIGJlIHVuZGVydGF4ZWQuIAoKVGhlcmUgYXJlIG1hbnkgZGlmZmVyZW50IHdheXMgd2UgbWlnaHQgY29udGludWUgdG8gZXhhbWluZSB0aGlzIG1vZGVsIChlZy4gYXJlIHRoZXJlIGRpZmZlcmVuY2VzIGJ5IHppcGNvZGUpIGJ1dCBmb3Igbm93LCB3ZSdsbCBtb3ZlIG9uLgoKIyMjIDguIFVzZSB0aGUgbW9kZWwgCgpIb3cgbWlnaHQgdXNlIHRoaXMgbW9kZWw/IE9uZSBzaW1wbGUgd2F5IGlzIHRvIHByZWRpY3QgbmV3IHZhbHVlcy4gV2Ugc2F3IHRoYXQgd2UgY291bGQgYWRkIHRoZSBwcmVkaWN0ZWQgdmFsdWVzIHRvIHRoZSB0ZXN0IGRhdGEgdXNpbmcgdGhlIGBjb2xsZWN0X3ByZWRpY3Rpb25zKClgIGZ1bmN0aW9uLiBCZWxvdywgSSBwcmVkaWN0IHRoZSB2YWx1ZSBmb3Igb25lIG5ldyBvYnNlcnZhdGlvbiB1c2luZyB0aGUgYHByZWRpY3QoKWAgZnVuY3Rpb24uIFdlIHB1dCB0aGUgdmFsdWVzIG9mIGVhY2ggdmFyaWFibGUgaW4gYSBkYXRhc2V0LCBpbiB0aGlzIGNhc2UgYSBgdGliYmxlKClgLiBXZSBuZWVkIHRvIGhhdmUgdmFsdWVzIGZvciBhbGwgdGhlIHZhcmlhYmxlcyB0aGF0IHdlcmUgb3JpZ2luYWxseSBpbiB0aGUgZGF0YXNldCBwYXNzZWQgdG8gdGhlIGByZWNpcGUoKWAsIPCfk50gKipldmVuIHRoZSBldmFsdWF0aW9uIG9uZXMgdGhhdCBkb24ndCBnZXQgdXNlZCBpbiB0aGUgbW9kZWwqKi4gV2UgY2FuICoqaGF2ZSBleHRyYSB2YXJpYWJsZXMqKiBpbiB0aGVyZSwgdGhvdWdoLCBsaWtlIHRoZSBvbmUgSSBoYXZlIGNhbGxlZCBgZ2FyYmFnZWAuIEkgc2hvdyBhIHByZWRpY3RlZCB2YWx1ZSAoZm9yIGEgbGluZWFyIG1vZGVsLCBgdHlwZSA9ICJudW1lcmljImApIGFuZCBhIGNvbmZpZGVuY2UgaW50ZXJ2YWwgKGB0eXBlID0gImNvbmZfaW50ImApLiAoKirnroDljZXor7TlsLHmmK86IOWPmOmHj+WQjeimgeS4gOagtywg5Y+q6IO95aSa5LiN6IO95bCRKiopCgog8J+TnSAqKk5PVEUqKjogVGhpcyBpcyBhIGJpdCBvZiBhbiBhc2lkZSwgYnV0IGFuIGltcG9ydGFudCBvbmUuIElmIEkgd291bGQgaGF2ZSB1c2VkIHRoZSBgc3RlcF9sb2coKWAgZnVuY3Rpb24gdG8gdHJhbnNmb3JtIHRoZSByZXNwb25zZSB2YXJpYWJsZSBgcHJpY2VgIGluIHRoZSBwcmUtcHJvY2Vzc2luZyBzdGVwLCByYXRoZXIgdGhhbiB0cmFuc2Zvcm1pbmcgaXQgYmVmb3JlIHRoYXQsIHdlIHdvdWxkIHNlZSBhbiBlcnJvciBtZXNzYWdlIGluIHRoZSBgcHJlZGljdCgpYCBiZWxvdyAqKmJlY2F1c2UgaXQgd291bGQgdHJ5IHRvIHJ1biB0aGF0IHRyYW5zZm9ybWF0aW9uIHN0ZXAsIGJ1dCB0aGVyZSB3b3VsZG4ndCBiZSBhIGBwcmljZWAgdmFyaWFibGUqKijov5nlsLHmmK/opoHlnKggcmVjaXBlcyDkuYvliY3ov5vooYwgWSDnmoTmlbDmja7ovazmjaIsIOi/meagt+eahOivneWcqOi/kOihjOaVsOaNrumihOa1i+eahOaXtuWAmeaJjeS4jeS8muWHuumUmSwg5Zug5Li65paw55qE5pWw5o2u5pyJ5Y+v6IO95piv5rKh5pyJIFkg5Y+Y6YeP55qEKS4gKipJbiByZWFsIGxpZmUsIGl0IHdvdWxkIHVzdWFsbHkgYmUgdGhlIGNhc2UgdGhhdCB5b3UgZG9uJ3QgaGF2ZSBhIHZhbHVlIGZvciB0aGUgdmFyaWFibGUgeW91IGFyZSB0cnlpbmcgdG8gcHJlZGljdCoqLgoKSSBvcmlnaW5hbGx5IHRyaWVkIHRvIHNvbHZlIHRoaXMgcHJvYmxlbSBieSBhZGRpbmcgYHNraXAgPSBUUlVFYCB0byB0aGUgYHN0ZXBfbG9nKClgIGZ1bmN0aW9uLCBidXQgdGhlbiB0aGUgZXZhbHVhdGlvbiBtZXRyaWNzIGluIGBjb2xsZWN0X21ldHJpY3MoKWAgY29tcGFyZWQgdGhlIHByZWRpY3RlZCBsb2cgcHJpY2UgdG8gdGhlIGFjdHVhbCBwcmljZSAtIHlpa2VzISBUaGlzIGlzIGRpc2N1c3NlZCBpbiBhIGZldyBwbGFjZXMgb25saW5lIC0gW3R1bmluZyBmYWlscyB3aGVuIHJlY2lwZSBzdGVwIGFmZmVjdHMgYW4gb3V0Y29tZSB3aXRoIHNraXAgPSBUUlVFIMK3IElzc3VlICM0NyDCtyB0aWR5bW9kZWxzL3dvcmtmbG93c10oaHR0cHM6Ly9naXRodWIuY29tL3RpZHltb2RlbHMvd29ya2Zsb3dzL2lzc3Vlcy80NykncyBvbmUuIAoKPiAKPgo+IPCflKUgIPCfk50gOiBUaGUgc29sdXRpb24gaXMgdG8gdHJhbnNmb3JtIHRoZSByZXNwb25zZSB2YXJpYWJsZSBiZWZvcmUgZG9pbmcgYW55IG9mIHRoZSBtb2RlbGluZyBzdGVwcywgYXMgSSBtZW50aW9uZWQgaW4gdGhlIERhdGEgc3BsaXR0aW5nIHNlY3Rpb24uCj4KPiAKCmBgYHtyIHByZWQtc2luZ2xlfQpwcmVkaWN0KAogIGhvdXNlX2xtX2ZpdCwKICBuZXdfZGF0YSA9IHRpYmJsZShpZCA9ICIwNzA1NzAwMzkwIiwKICAgICAgICAgICAgICAgICAgICBkYXRlID0geW1kKCIyMDE0LTA5LTAzIiksCiAgICAgICAgICAgICAgICAgICAgYmVkcm9vbXMgPSAzLAogICAgICAgICAgICAgICAgICAgIGJhdGhyb29tcyA9IDIuMjUsCiAgICAgICAgICAgICAgICAgICAgc3FmdF9saXZpbmcgPSAyMDIwLAogICAgICAgICAgICAgICAgICAgIHNxZnRfbG90ID0gODM3OSwKICAgICAgICAgICAgICAgICAgICBmbG9vcnMgPSAyLAogICAgICAgICAgICAgICAgICAgIHdhdGVyZnJvbnQgPSBGQUxTRSwKICAgICAgICAgICAgICAgICAgICB2aWV3ID0gMCwKICAgICAgICAgICAgICAgICAgICBjb25kaXRpb24gPSAiMyIsCiAgICAgICAgICAgICAgICAgICAgZ3JhZGUgPSAiNyIsCiAgICAgICAgICAgICAgICAgICAgc3FmdF9hYm92ZSA9IDIwMjAsCiAgICAgICAgICAgICAgICAgICAgc3FmdF9iYXNlbWVudCA9IDAsCiAgICAgICAgICAgICAgICAgICAgeXJfYnVpbHQgPSAxOTk0LAogICAgICAgICAgICAgICAgICAgIHlyX3Jlbm92YXRlZCA9IDAsCiAgICAgICAgICAgICAgICAgICAgemlwY29kZSA9ICI5ODAzOCIsCiAgICAgICAgICAgICAgICAgICAgbGF0ID0gNDcuMzgyOCwKICAgICAgICAgICAgICAgICAgICBsb25nID0gLTEyMi4wMjMsCiAgICAgICAgICAgICAgICAgICAgc3FmdF9saXZpbmcxNSA9IDIwMjAsCiAgICAgICAgICAgICAgICAgICAgc3FmdF9sb3QxNSA9IDgwMzEsCiAgICAgICAgICAgICAgICAgICAgZ2FyYmFnZSA9ICJsb29rLCBpdCdzIGdhcmJhZ2UiKSwKICB0eXBlID0gIm51bWVyaWMiLAogIGxldmVsID0gMC45NQopCgpwcmVkaWN0KAogIGhvdXNlX2xtX2ZpdCwKICBuZXdfZGF0YSA9IHRpYmJsZShpZCA9ICIwNzA1NzAwMzkwIiwKICAgICAgICAgICAgICAgICAgICBkYXRlID0geW1kKCIyMDE0LTA5LTAzIiksCiAgICAgICAgICAgICAgICAgICAgYmVkcm9vbXMgPSAzLAogICAgICAgICAgICAgICAgICAgIGJhdGhyb29tcyA9IDIuMjUsCiAgICAgICAgICAgICAgICAgICAgc3FmdF9saXZpbmcgPSAyMDIwLAogICAgICAgICAgICAgICAgICAgIHNxZnRfbG90ID0gODM3OSwKICAgICAgICAgICAgICAgICAgICBmbG9vcnMgPSAyLAogICAgICAgICAgICAgICAgICAgIHdhdGVyZnJvbnQgPSBGQUxTRSwKICAgICAgICAgICAgICAgICAgICB2aWV3ID0gMCwKICAgICAgICAgICAgICAgICAgICBjb25kaXRpb24gPSAiMyIsCiAgICAgICAgICAgICAgICAgICAgZ3JhZGUgPSAiNyIsCiAgICAgICAgICAgICAgICAgICAgc3FmdF9hYm92ZSA9IDIwMjAsCiAgICAgICAgICAgICAgICAgICAgc3FmdF9iYXNlbWVudCA9IDAsCiAgICAgICAgICAgICAgICAgICAgeXJfYnVpbHQgPSAxOTk0LAogICAgICAgICAgICAgICAgICAgIHlyX3Jlbm92YXRlZCA9IDAsCiAgICAgICAgICAgICAgICAgICAgemlwY29kZSA9ICI5ODAzOCIsCiAgICAgICAgICAgICAgICAgICAgbGF0ID0gNDcuMzgyOCwKICAgICAgICAgICAgICAgICAgICBsb25nID0gLTEyMi4wMjMsCiAgICAgICAgICAgICAgICAgICAgc3FmdF9saXZpbmcxNSA9IDIwMjAsCiAgICAgICAgICAgICAgICAgICAgc3FmdF9sb3QxNSA9IDgwMzEsCiAgICAgICAgICAgICAgICAgICAgZ2FyYmFnZSA9ICJsb29rLCBpdCdzIGdhcmJhZ2UiKSwKICB0eXBlID0gImNvbmZfaW50IiwKICBsZXZlbCA9IDAuOTUKKQpgYGAKCldlIGNvdWxkIGFsc28gZ2l2ZSBpdCBhbiBlbnRpcmUgZGF0YXNldC4gSGVyZSwgSSBqdXN0IHRha2UgYSBzYW1wbGUgZnJvbSB0aGUgb3JpZ2luYWwgZGF0YXNldCwgYWRkIGFuIGV4dHJhIHZhcmlhYmxlIChqdXN0IHRvIHNob3cgeW91IHRoYXQgeW91IGNhbiBoYXZlIG1vcmUgdGhhbiB3aGF0IHlvdSBuZWVkKSwgYW5kIHByZWRpY3Qgd2l0aCBpdC4KCmBgYHtyIHByZWQtc2V0fQpzZXQuc2VlZCgzMjcpCgpmYWtlX25ld19kYXRhIDwtIGhvdXNlX3ByaWNlcyAlPiUgCiAgc2FtcGxlX24oMjApICU+JSAKICBtdXRhdGUoZXh0cmFfdmFyID0gMToyMCkKCnByZWRpY3QoaG91c2VfbG1fZml0LCAKICAgICAgICBmYWtlX25ld19kYXRhKQpgYGAKClNpbmNlIHRoZSBgcHJlZGljdCgpYCBmdW5jdGlvbiB3aWxsIGFsd2F5cyByZXR1cm4gdGhlIHNhbWUgbnVtYmVyIG9mIHJvd3MgYW5kIGluIHRoZSBzYW1lIG9yZGVyIGFzIHRoZSBkYXRhc2V0IHdlIHB1dCBpbiwgd2UgY2FuIGVhc2lseSBhcHBlbmQgdGhlIHByZWRpY3Rpb24gdG8gdGhlIGRhdGFzZXQuCgpgYGB7ciBwcmVkLWJpbmR9CmZha2VfbmV3X2RhdGEgJT4lIAogIGJpbmRfY29scyhwcmVkaWN0KGhvdXNlX2xtX2ZpdCwKICAgICAgICAgICAgICAgICAgICBmYWtlX25ld19kYXRhKSkgCmBgYAoKV2UgY291bGQgYWxzbyBhZGQgYSBjb25maWRlbmNlIGludGVydmFsIGFuZCB1c2UgdGhlIGByZWxvY2F0ZSgpYCBmdW5jdGlvbiB0byBtb3ZlIGFyb3VuZCBzb21lIHZhcmlhYmxlcy4KCmBgYHtyIHByZWQtYmluZC1jaX0KZmFrZV9uZXdfZGF0YSAlPiUgCiAgYmluZF9jb2xzKHByZWRpY3QoaG91c2VfbG1fZml0LAogICAgICAgICAgICAgICAgICAgIGZha2VfbmV3X2RhdGEpKSAlPiUgCiAgYmluZF9jb2xzKHByZWRpY3QoaG91c2VfbG1fZml0LAogICAgICAgICAgICAgICAgICAgIGZha2VfbmV3X2RhdGEsIAogICAgICAgICAgICAgICAgICAgIHR5cGUgPSAiY29uZl9pbnQiKSkgJT4lIAogICMgcHV0IHRoZSBwcmVkIGNvbCBhZnRlciB0aGUgbG9nX3ByaWNlIGNvbAogIHJlbG9jYXRlKGxvZ19wcmljZSwgc3RhcnRzX3dpdGgoIi5wcmVkIiksIAogICAgICAgICAgIC5hZnRlciA9IGlkKQpgYGAKCuKdkyAgV2hhdCBpZiB3ZSBkb24ndCB3YW50IHRvIHVzZSB0aGUgbW9kZWwgaW4gdGhpcyBSIHNlc3Npb24/IAoKVGhhdCB3b3VsZCBiZSBxdWl0ZSBhIGNvbW1vbiBvY2N1cnJlbmNlLiBBZnRlciBidWlsZGluZyBhIG1vZGVsLCB3ZSB3b3VsZCBvZnRlbiB3YW50IHRvIHNhdmUgdGhlIG1vZGVsIGFuZCB1c2UgaXQgYXQgYSBsYXRlciB0aW1lIHRvIGFwcGx5IHRvIG5ldyBkYXRhLiBXZSdsbCBnZXQgaW50byBzb21lIG1vcmUgY29tcGxleCB3YXlzIG9mIGRvaW5nIHRoaXMgZXZlbnR1YWxseSwgYnV0IGZvciBub3csIGxldCdzIGRvIHRoZSBmb2xsb3dpbmc6CgoxLiBTYXZlIHRoZSBtb2RlbCB1c2luZyBgc2F2ZVJEUygpYC4gVGhpcyBtb2RlbCBpcyBzYXZlZCB0byB0aGUgY3VycmVudCBwcm9qZWN0IGZvbGRlciAoYXNzdW1pbmcgeW91J3JlIHVzaW5nIGEgcHJvamVjdCByaWdodCBub3cpLCBidXQgeW91IGNvdWxkIHNhdmUgaXQgYW55d2hlcmUgeW91J2QgbGlrZS4KCmBgYHtyfQpzYXZlUkRTKGhvdXNlX2xtX2ZpdCwgImhvdXNlX2xtX2ZpdC5yZHMiKQpgYGAKCjIuIFJlYWQgdGhlIG1vZGVsIGJhY2sgaW4gdXNpbmcgYHJlYWRSRFMoKWAuIEdvIGxvb2sgYXQgYGhvdXNlX2xtX3JlYWRgIGluIHRoZSBlbnZpcm9ubWVudCwgYW5kIHlvdSdsbCBzZWUgdGhhdCwgaW5kZWVkLCBpdCBpcyB0aGUgd29ya2Zsb3cgd2Ugc2F2ZWQhIGByIGVtbzo6amkoImh1Z2dpbmdfZmFjZSIpYAoKYGBge3J9CmhvdXNlX2xtX3JlYWQgPC0gcmVhZFJEUygiaG91c2VfbG1fZml0LnJkcyIpCmBgYAoKMy4gVXNlIHRoZSBtb2RlbCB3ZSByZWFkIGJhY2sgaW4gdG8gcHJlZGljdCBuZXcgZGF0YS4gSnVzdCBsaWtlIHdlIGRpZCBiZWZvcmUsIHdlIGNhbiB1c2UgdGhlIGBwcmVkaWN0KClgIGZ1bmN0aW9uIHRvIHByZWRpY3QgbmV3IHZhbHVlcy4gSSB1c2UgdGhlIHNhbWUgYGZha2VfbmV3X2RhdGFgIEkgdXNlZCBiZWZvcmUuCgpgYGB7ciBwcmVkLWJpbmQtY2ktbmV3fQpmYWtlX25ld19kYXRhICU+JSAKICBiaW5kX2NvbHMocHJlZGljdChob3VzZV9sbV9yZWFkLAogICAgICAgICAgICAgICAgICAgIGZha2VfbmV3X2RhdGEpKSAlPiUgCiAgYmluZF9jb2xzKHByZWRpY3QoaG91c2VfbG1fcmVhZCwKICAgICAgICAgICAgICAgICAgICBmYWtlX25ld19kYXRhLCAKICAgICAgICAgICAgICAgICAgICB0eXBlID0gImNvbmZfaW50IikpICU+JSAKICByZWxvY2F0ZShsb2dfcHJpY2UsIHN0YXJ0c193aXRoKCIucHJlZCIpLCAKICAgICAgICAgICAuYWZ0ZXIgPSBpZCkKYGBgCgoKIyMjIDUuIFR1bmluZyBtb2RlbCBwYXJhbWV0ZXJzCgpXaXRoIHRoZSBmaXJzdCBtb2RlbCwgdGhlcmUgd2VyZW4ndCBhbnkgcGFyYW1ldGVycyB0byB0dW5lLiBMZXQncyBnbyBiYWNrIHRvIHN0ZXAgIzUgYW5kIGxvb2sgYXQgaG93IHRoZSB3b3JrZmxvdyBjaGFuZ2VzIHdoZW4gd2UgaGF2ZSB0byBkbyB0aGlzIGV4dHJhIHN0ZXAuIAoKTm93IHdlIGFyZSBnb2luZyB0byB0cnkgdXNpbmcgW0xlYXN0IEFic29sdXRlIFNocmlua2FnZSBhbmQgU2VsZWN0aW9uIE9wZXJhdG9yIChMQVNTTyldKGh0dHBzOi8vYnJhZGxleWJvZWhta2UuZ2l0aHViLmlvL0hPTUwvcmVndWxhcml6ZWQtcmVncmVzc2lvbi5odG1sI3doeSkgcmVncmVzc2lvbi4gVGhpcyBtZXRob2Qgc2hyaW5rcyBzb21lIGNvZWZmaWNpZW50cyB0byAwIGJhc2VkIG9uIGEgcGVuYWx0eSB0ZXJtLiBXZSB3aWxsIHVzZSBjcm9zcy12YWxpZGF0aW9uIHRvIGhlbHAgdXMgZmluZCB0aGUgYmVzdCBwZW5hbHR5IHRlcm0uIAoKV2Ugd2lsbCBzZXQgdXAgdGhlIG1vZGVsIHNpbWlsYXIgdG8gaG93IHdlIHNldCB1cCB0aGUgbGluZWFyIG1vZGVsLCBidXQgYWRkIGEgYHNldF9hcmdzKClgIGZ1bmN0aW9uLiBUaGUgYHR1bmUoKWAgYXJndW1lbnQgdG8gdGhlIGBwZW5hbHR5YCB0ZXJtIGlzIGEgcGxhY2Vob2xkZXIuIFdlIGFyZSB0ZWxsaW5nIGl0IHRoYXQgd2UgYXJlIGdvaW5nIHRvIHR1bmUgdGhlIHBlbmFsdHkgcGFyYW1ldGVyIGxhdGVyLgoKYGBge3IgbGFzc29fbW9kfQpob3VzZV9sYXNzb19tb2QgPC0gCiAgIyBEZWZpbmUgYSBsYXNzbyBtb2RlbCAKICAjIEkgYmVsaWV2ZSBkZWZhdWx0IGlzIG1peHR1cmUgPSAxKExBU09PKSBzbyBwcm9iYWJseSBkb24ndCBuZWVkIAogIGxpbmVhcl9yZWcobWl4dHVyZSA9IDEpICU+JSAKICAjIFNldCB0aGUgZW5naW5lIHRvICJnbG1uZXQiIAogIHNldF9lbmdpbmUoImdsbW5ldCIpICU+JSAKICAjIFRoZSBwYXJhbWV0ZXJzIHdlIHdpbGwgdHVuZS4KICBzZXRfYXJncyhwZW5hbHR5ID0gdHVuZSgpKSAlPiUgCiAgIyBVc2UgInJlZ3Jlc3Npb24iCiAgc2V0X21vZGUoInJlZ3Jlc3Npb24iKQpgYGAKClRvIHNlZSB0aGUgYXJndW1lbnRzIGF2YWlsYWJsZSBmb3IgdHVuaW5nLCBnbyB0byB0aGUgW0V4cGxvcmUgTW9kZWwgQXJndW1lbnRzXShodHRwczovL3d3dy50aWR5bW9kZWxzLm9yZy9maW5kL3BhcnNuaXAvKSBzZWN0aW9uIG9mIHRoZSBgcGFyc25pcGAgZG9jdW1lbnRhdGlvbiBhbmQgc2VhcmNoIHRoZSBtb2RlbCB0eXBlIGFuZCBlbmdpbmUgeW91IGFyZSBpbnRlcmVzdGVkIGluLiBCZWxvdyBJIHByaW50ZWQgdGhlIGFyZ3VtZW50cyB3ZSBjYW4gdHVuZSBmb3IgYGxpbmVhcl9yZWdgIHVzaW5nIGBnbG1uZXRgIChMQVNTTykuIFdlIGNvdWxkIGhhdmUgYWxzbyB0dW5lZCB0aGUgYG1peHR1cmVgIHBhcmFtZXRlciwgYnV0ICoqSSBzZXQgaXQgdG8gMSB0byBleHBsaWNpdGx5IHVzZSBMQVNTTyoqLgoKPGNlbnRlcj4KPGltZyBzcmM9Im1sLXJldmlld19pbWFnZXMvaW1hZ2UtMjAyMTA2MjQxNjU0MzQxNzMucG5nIiBhbHQ9ImltYWdlLTIwMjEwNjI0MTY1NDM0MTczIiBzdHlsZT0iem9vbTo1MCU7IiAvPgo8L2NlbnRlcj4KCkFuZCB0aGVuIHdlIGNyZWF0ZSBhIExBU1NPIHdvcmtmbG93LiBOb3RpY2UgdGhhdCB3ZSdyZSB1c2luZyB0aGUgc2FtZSByZWNpcGUgc3RlcCB0aGF0IHdlIHVzZWQgaW4gdGhlIHJlZ3VsYXIgbGluZWFyIG1vZGVsLgoKYGBge3IgbGFzc29fd29ya2Zsb3d9CmhvdXNlX2xhc3NvX3dmIDwtIAogICMgU2V0IHVwIHRoZSB3b3JrZmxvdwogIHdvcmtmbG93KCkgJT4lIAogICMgQWRkIHRoZSByZWNpcGUKICBhZGRfcmVjaXBlKGhvdXNlX3JlY2lwZSkgJT4lIAogICMgQWRkIHRoZSBtb2RlbGluZwogIGFkZF9tb2RlbChob3VzZV9sYXNzb19tb2QpCgpob3VzZV9sYXNzb193ZgpgYGAKCmByIGVtbzo6amkoImV5ZXMiKWAgSGVyZSdzIHdoZXJlIHNvbWUgb2YgdGhlIG5ldyBzdGVwcyBjb21lIGluLiBXZSB1c2UgdGhlIGBncmlkX3JlZ3VsYXIoKWAgZnVuY3Rpb24gZnJvbSB0aGUgYGRpYWxzYCBsaWJyYXJ5IHRvIGNob29zZSBzb21lIHZhbHVlcyBvZiB0aGUgYHBlbmFsdHlgIHBhcmFtZXRlciBmb3IgdXMuIEFsdGVybmF0aXZlbHksIHdlIGNvdWxkIGdpdmUgaXQgYSB2ZWN0b3Igb2YgdmFsdWVzIHdlIHdhbnQgdG8gdHJ5LgoKYGBge3IgdHVuZV9ncmlkfQpwZW5hbHR5X2dyaWQgPC0gZ3JpZF9yZWd1bGFyKHBlbmFsdHkoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXZlbHMgPSAyMCkKcGVuYWx0eV9ncmlkIApgYGAKClRoZW4sIHVzZSB0aGUgYHR1bmVfZ3JpZCgpYCBmdW5jdGlvbiB0byBmaXQgdGhlIG1vZGVsIHVzaW5nIGNyb3NzLXZhbGlkYXRpb24gZm9yIGFsbCBgcGVuYWx0eV9ncmlkYCB2YWx1ZXMgYW5kIGV2YWx1YXRlIG9uIGFsbCB0aGUgZm9sZHMuIAoKYGBge3IgdHVuZX0KaG91c2VfbGFzc29fdHVuZSA8LSAKICBob3VzZV9sYXNzb193ZiAlPiUgCiAgdHVuZV9ncmlkKAogICAgcmVzYW1wbGVzID0gaG91c2VfY3YsCiAgICBncmlkID0gcGVuYWx0eV9ncmlkCiAgICApCgpob3VzZV9sYXNzb190dW5lCmBgYAoKVGhlbiBsb29rIGF0IHRoZSBjcm9zcy12YWxpZGF0ZWQgcmVzdWx0cyBpbiBhIHRhYmxlLgoKYGBge3IgdHVuZV9yZXN1bHRzfQojIFRoZSBybXNlIGZvciBlYWNoIGZvbGQ6CmhvdXNlX2xhc3NvX3R1bmUgJT4lIAogIHNlbGVjdChpZCwgLm1ldHJpY3MpICU+JSAKICB1bm5lc3QoLm1ldHJpY3MpICU+JSAKICBmaWx0ZXIoLm1ldHJpYyA9PSAicm1zZSIpCgojIHJtc2UgYXZlcmFnZWQgb3ZlciBhbGwgZm9sZHM6CmhvdXNlX2xhc3NvX3R1bmUgJT4lIAogIGNvbGxlY3RfbWV0cmljcygpICU+JSAKICBmaWx0ZXIoLm1ldHJpYyA9PSAicm1zZSIpIApgYGAKCkFuZCwgZXZlbiBiZXR0ZXIsIHdlIGNhbiB2aXN1YWxpemUgdGhlIHJlc3VsdHMuIFdlIGNhbiBzZWUgdGhhdCB0aGUgUk1TRSBzdGF5cyBmYWlybHkgY29uc2lzdGVudGx5IGxvdyB1bnRpbCBqdXN0IGJlZm9yZSAkMTBeey0zfSQKCmBgYHtyIHR1bmUtdml6fQojIFZpc3VhbGl6ZSBybXNlIHZzLiBwZW5hbHR5CmhvdXNlX2xhc3NvX3R1bmUgJT4lIAogIGNvbGxlY3RfbWV0cmljcygpICU+JSAKICBmaWx0ZXIoLm1ldHJpYyA9PSAicm1zZSIpICU+JSAKICBnZ3Bsb3QoYWVzKHggPSBwZW5hbHR5LCB5ID0gbWVhbikpICsKICBnZW9tX3BvaW50KCkgKwogIGdlb21fbGluZSgpICsKICBzY2FsZV94X2xvZzEwKAogICBicmVha3MgPSBzY2FsZXM6OnRyYW5zX2JyZWFrcygibG9nMTAiLCBmdW5jdGlvbih4KSAxMF54KSwKICAgbGFiZWxzID0gc2NhbGVzOjp0cmFuc19mb3JtYXQoImxvZzEwIixzY2FsZXM6Om1hdGhfZm9ybWF0KDEwXi54KSkpICsKICBsYWJzKHggPSAicGVuYWx0eSIsIHkgPSAicm1zZSIpCmBgYAoKV2UgY2hvb3NlIHRoZSBiZXN0IHBlbmFsdHkgcGFyYW1ldGVyIGFzIHRoZSBvbmUgd2l0aCB0aGUgc21hbGxlc3QgY3Jvc3MtdmFsaWRhdGVkIFJNU0UuIFRoZSBgc2VsZWN0X2Jlc3QoKWAgZnVuY3Rpb24gZG9lcyB0aGlzLiAKCmBgYHtyfQpob3VzZV9sYXNzb190dW5lICU+JSAKICBzaG93X2Jlc3QobWV0cmljID0gInJtc2UiKQpgYGAKCgpgYGB7ciBiZXN0LXR1bmV9CiMgQmVzdCB0dW5pbmcgcGFyYW1ldGVyIGJ5IHNtYWxsZXN0IHJtc2UKYmVzdF9wYXJhbSA8LSBob3VzZV9sYXNzb190dW5lICU+JSAKICBzZWxlY3RfYmVzdChtZXRyaWMgPSAicm1zZSIpCmJlc3RfcGFyYW0KYGBgCgpUaGVyZSBhcmUgb3RoZXIgd2F5cyB5b3UgY2FuIHNlbGVjdCBwYXJhbWV0ZXJzLCBsaWtlIGBzZWxlY3RfYnlfb25lX3N0ZF9lcnIoKWAgd2hpY2ggInNlbGVjdHMgdGhlIG1vc3Qgc2ltcGxlIG1vZGVsIHRoYXQgaXMgd2l0aGluIG9uZSBzdGFuZGFyZCBlcnJvciBvZiB0aGUgbnVtZXJpY2FsbHkgb3B0aW1hbCByZXN1bHRzIi4gVG8gdXNlIHRoaXMsIHdlIG5lZWQgYXQgbGVhc3Qgb25lIG1vcmUgYXJndW1lbnQ6IHRoZSBwYXJhbWV0ZXIgdG8gc29ydCB0aGUgbW9kZWwgZnJvbSBtb3N0IHNpbXBsZSB0byBtb3N0IGNvbXBsZXguIFNvLCBpZiB1c2luZyBnbG1uZXQncyBwZW5hbHR5IHBhcmFtZXRlciwgc2luY2UgYSBiaWdnZXIgcGVuYWx0eSB3aWxsIGJlIGEgc2ltcGxlciBtb2RlbCwgSSBzaG91bGQgcHV0IGBkZXNjKHBlbmFsdHkpYCBpbiBhcyB0aGUgYXJndW1lbnQuCgpgYGB7ciBvbmUtc2UtdHVuZX0KIyBCZXN0IHR1bmluZyBwYXJhbWV0ZXIgYnkgc21hbGxlc3Qgcm1zZQpvbmVfc2VfcGFyYW0gPC0gaG91c2VfbGFzc29fdHVuZSAlPiUgCiAgc2VsZWN0X2J5X29uZV9zdGRfZXJyKG1ldHJpYyA9ICJybXNlIiwgZGVzYyhwZW5hbHR5KSkKb25lX3NlX3BhcmFtCmBgYAoKQmVjYXVzZSBhIGxhcmdlciBwZW5hbHR5IHBhcmFtZXRlciB3aWxsIGZpdCBhIHNpbXBsZXIgbW9kZWwgKG1vcmUgdGVybXMgd2lsbCBsaWtlbHkgZ28gdG8gemVybykuIEknbGwgZ28gd2l0aCB0aGUgYG9uZV9zZV9wYXJhbWAsIGVzcGVjaWFsbHkgc2luY2UgdGhlIFJNU0UgaXMgc28gY2xvc2UgdG8gdGhlICJiZXN0IiBtb2RlbCdzIFJNU0UuCgpPbmNlIHdlIGNob29zZSB0aGUgcGFyYW1ldGVyIHdlIHdhbnQsIHdlIGFkanVzdCB0aGUgd29ya2Zsb3cgdG8gaW5jbHVkZSB0aGUgYmVzdCB0dW5pbmcgcGFyYW1ldGVyIHVzaW5nIHRoZSBgZmluYWxpemVfd29ya2Zsb3coKWAgZnVuY3Rpb24uCgpgYGB7ciB0dW5lX3dmfQpob3VzZV9sYXNzb19maW5hbF93ZiA8LSBob3VzZV9sYXNzb193ZiAlPiUgCiAgZmluYWxpemVfd29ya2Zsb3cob25lX3NlX3BhcmFtKQpob3VzZV9sYXNzb19maW5hbF93ZgpgYGAKCk5vdyB3ZSBjb3VsZCBmaXQgdGhpcyB0byB0aGUgdHJhaW5pbmcgZGF0YSBhbmQgbG9vayBhdCB0aGUgcmVzdWx0aW5nIG1vZGVsLiBXZSBjYW4gc2VlIGEgZmV3IG9mIHRoZSB0ZXJtcyBoYXZlIGNvZWZmaWNpZW50cyBvZiAwIChhbHRob3VnaCBub3QgYXMgbWFueSBhcyBJIHdvdWxkIGhhdmUgZXhwZWN0ZWQpLgoKYGBge3IgbGFzc29fdHJhaW59CmhvdXNlX2xhc3NvX2ZpbmFsX21vZCA8LSBob3VzZV9sYXNzb19maW5hbF93ZiAlPiUgCiAgZml0KGRhdGEgPSBob3VzZV90cmFpbmluZykKCmhvdXNlX2xhc3NvX2ZpbmFsX21vZCAlPiUgCiAgcHVsbF93b3JrZmxvd19maXQoKSAlPiUgCiAgdGlkeSgpIApgYGAKCldlIGNhbiBhbHNvIHZpc3VhbGl6ZSB2YXJpYWJsZSBpbXBvcnRhbmNlLgoKYGBge3IgdmlwfQojIFZpc3VhbGl6ZSB2YXJpYWJsZSBpbXBvcnRhbmNlCmhvdXNlX2xhc3NvX2ZpbmFsX21vZCAlPiUgCiAgcHVsbF93b3JrZmxvd19maXQoKSAlPiUgCiAgdmlwKCkKYGBgCgpMYXN0bHksIHdlIGFwcGx5IHRoZSBtb2RlbCB0byB0aGUgdGVzdCBkYXRhIGFuZCBleGFtaW5lIHNvbWUgZmluYWwgbWV0cmljcy4gV2UgYWxzbyBzaG93IHRoZSBtZXRyaWNzIGZyb20gdGhlIHJlZ3VsYXIgbGluZWFyIG1vZGVsLiBJdCBsb29rcyBsaWtlIHBlcmZvcm1hbmNlIGZvciB0aGUgTEFTU08gbW9kZWwgaXMgZXZlciBzbyBzbGlnaHRseSBiZXR0ZXIsIGJ1dCBqdXN0IGJhcmVseS4gSXQncyBhbHNvIGEgZ29vZCBzaWduIHRoYXQgdGhlc2UgUk1TRSdzIGFyZSBzaW1pbGFyIHRvIHRoZSBjcm9zcy12YWxpZGF0ZWQgUk1TRSdzLgoKYGBge3IgbGFzc29fdGVzdH0KIyBGaXQgbW9kZWwgd2l0aCBiZXN0IHR1bmluZyBwYXJhbWV0ZXIocykgdG8gdHJhaW5pbmcgZGF0YSBhbmQgYXBwbHkgdG8gdGVzdCBkYXRhCmhvdXNlX2xhc3NvX3Rlc3QgPC0gaG91c2VfbGFzc29fZmluYWxfd2YgJT4lIAogIGxhc3RfZml0KGhvdXNlX3NwbGl0KQoKIyBNZXRyaWNzIGZvciBtb2RlbCBhcHBsaWVkIHRvIHRlc3QgZGF0YQpob3VzZV9sYXNzb190ZXN0ICU+JSAKICBjb2xsZWN0X21ldHJpY3MoKQoKIyBDb21wYXJlIHRvIHJlZ3VsYXIgbGluZWFyIHJlZ3Jlc3Npb24gcmVzdWx0cwpjb2xsZWN0X21ldHJpY3MoaG91c2VfbG1fdGVzdCkKYGBgCgoKCg==" download="ml-review.Rmd">
<button class="btn btn-info"><i class="fa fa-save"></i> Download .Rmd file</button>
</a>
```
</div>

</div>


## Resources

Here are some great resources. I will reference some of them throughout.

* [Hands on Machine Learning with R](https://bradleyboehmke.github.io/HOML/) (HOML, for short) by Bradley Boehmke and Brandon Greenwell is the textbook I used in the Machine Learning course I taught in spring of 2020. It is a great place to go to review some of the model algorithms and concepts.  

* [ISLR](https://www.statlearning.com/) by James, Witten, Hastie, and Tibshirani goes deeper into the math of the algorithms. You can download their book at this site.

* Tidymodels
  - [Lisa's tidymodels noRth presentation](https://youtu.be/tVZO-aoXStE) gives an example of using `tidymodels`. I will go through the same example below, with a few added parts. The code has changed slightly in some places, too.
  - [tidymodels.org](https://www.tidymodels.org/), specifically the [case study](https://www.tidymodels.org/start/case-study/), walks through examples of using the `tidymodels` suite.  
  - [Tidy Models with R textbook](https://www.tmwr.org/) by Julia Silge and Max Kuhn provides more in-depth explanations of the `tidymodels` functions with extended examples.
  - [Julia Silge's blog](https://juliasilge.com/) with even more examples!

## Review

Most of you probably learned about machine learning algorithms using the `caret` R package. Before jumping into the new `tidymodels` package, let's remember some of the key machine learning concepts. 

Let's start with an overview of the process. You covered many of these in your machine learning course. If you need more of a refresher than what I provide, see the [*Modeling Process*](https://bradleyboehmke.github.io/HOML/process.html) chapter of HOML.

> [Hands-On Machine Learning with R](https://bradleyboehmke.github.io/HOML/index.html)
>
> 这是一本很棒的讲机器学习的书籍



![image-20210624143944804](ml-review_images/image-20210624143944804.png)

<div class="centered">
</div>


![image-20210624143407974](ml-review_images/image-20210624143407974.png)

And let's review what we do during each of these steps.

1. **Quick exploration**: **Read** in the data, check **variable types**, find which values each variable takes and **how often**, check **distributions** of quantitative variables, explore **missing values**.  📌 DO NOT do any modeling or transforming of data in this step(现在还不是做数据转换的时候).  
2. **Data splitting**: Split the data into **training and testing sets**. The testing dataset will not be used again until the very end. 
3. **Data pre-processing**: More in-depth data exploration, **feature engineering**, **variable transformations**. This step is usually pretty time-consuming.  
4. **Fitting model(s)**: Fit the models of interest on the training data.  
5. **Tuning parameters**: If the model in the previous step involved tuning parameters, use cross-validation (or similar method) to find the best parameter.  
6. **Evaluate & compare models**: Use cross-validation to evaluate the model. If you have a large number of models you are evaluating, you will probably limit the set of models to your best/favorite few during this step. The image below is to help you remember that process, which I have also written about below.

![image-20210624144138235](ml-review_images/image-20210624144138235.png)

  - In **$k$-fold cross-validation**, we divide the data randomly into $k$ approximately equal groups or *folds*. The schematic here shows 5-fold cross-validation.  
  - The model is fit on $k-1$ of the folds and the remaining fold is used to evaluate the model. Let's look at the first row in the schematic. Here the model is fit on the data that are in folds 2, 3, 4, and 5. The model is evaluated on the data in fold 1.  
  - **RMSE** is a common performance metric for models with a **quantitative response**. It is computed by taking the difference between the predicted and actual response for each observation, squaring it, and taking the square root of the average over all observations. Or, as a formula:

$$
RMSE = \sqrt{\frac{1}{n}\sum_{i=1}^n(y_i - \hat{y}_i)^2},
$$

  - So, again looking at the first row in the schematic, the model is fit to folds 2, 3, 4, and 5 and we would use that model to compute the RMSE for fold 1. In the second row, the model is fit to the data in folds 1, 3, 4, and 5 and that model is used to compute the RMSE for the data in the 2nd fold.  
 - After this is done for all 5 folds, we take the average RMSE, to obtain the overall performance. This overall error is sometimes called the **CV error**. Averaging the performance over $k$ folds gives a better estimate of the true error than using one hold-out set. It also allows us to estimate its variability.
 - For models with a categorical response, a common performance metric to evaluate a model is accuracy: out of all cases, the fraction of correct (true positives and true negatives) classifications. A cross-validated accuracy would be computed in a similar way to the cross-validated RMSE described above.

7. **Apply final few models to testing data**: After we limit the number of models to the top few, we will want to to apply it to the testing data, the data that hasn't been used at all during the modeling process. This will give us a measure of the model's performance and may help us make a final decision about which model to use. 

8. **Use the model or model deploy !**: This step may be simple, like applying the model to a single set of data, or it could be a lot more complex, requiring the model to be "put into production" so it can be **applied to new data in real-time**.

9. **Question the data and model**: This isn't really a single step but something that we should be doing through the modeling process. We should be working closely with people who know the data well so we assure that we are **interpreting and using it correctly**. And we should evaluate how the model might be used in new contexts, especially keeping in mind how the model could be used to do harm. 

## Using `tidymodels` for the process

In this section, I will show how we can use the **tidymodels** framework to execute the modeling process. I've updated the diagram from above to include some of the libraries and functions we'll use throughout the process. 

<center>

![image-20210624144525718](ml-review_images/image-20210624144525718.png)

![image-20210624145832107](ml-review_images/image-20210624145832107.png)



</center>

First, let's load some of the libraries we will use:

<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://tidyverse.tidyverse.org'>tidyverse</a></span><span class='op'>)</span>         <span class='co'># for reading in data, graphing, and cleaning</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://tidymodels.tidymodels.org'>tidymodels</a></span><span class='op'>)</span>        <span class='co'># for modeling ... tidily</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://glmnet.stanford.edu'>glmnet</a></span><span class='op'>)</span>            <span class='co'># for regularized regression, including LASSO</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/njtierney/naniar'>naniar</a></span><span class='op'>)</span>            <span class='co'># for examining missing values (NAs)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://lubridate.tidyverse.org'>lubridate</a></span><span class='op'>)</span>         <span class='co'># for date manipulation</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/moderndive/moderndive/issues'>moderndive</a></span><span class='op'>)</span>        <span class='co'># for King County housing data</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/koalaverse/vip/'>vip</a></span><span class='op'>)</span>               <span class='co'># for variable importance plots</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/rstudio/rmarkdown'>rmarkdown</a></span><span class='op'>)</span>         <span class='co'># for paged tables</span>
<span class='fu'><a href='https://ggplot2.tidyverse.org/reference/theme_get.html'>theme_set</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggtheme.html'>theme_minimal</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span> <span class='co'># my favorite ggplot2 theme :)</span>
</code></pre></div>
</div>

</div>


Read in the King County Housing data and take a look at the first 5 rows.

<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/utils/data.html'>data</a></span><span class='op'>(</span><span class='st'>"house_prices"</span><span class='op'>)</span>

<span class='va'>house_prices</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>5</span><span class='op'>)</span>
</code></pre></div>

```
# A tibble: 5 x 21
  id         date        price bedrooms bathrooms sqft_living sqft_lot
  <chr>      <date>      <dbl>    <int>     <dbl>       <int>    <int>
1 7129300520 2014-10-13 221900        3      1           1180     5650
2 6414100192 2014-12-09 538000        3      2.25        2570     7242
3 5631500400 2015-02-25 180000        2      1            770    10000
4 2487200875 2014-12-09 604000        4      3           1960     5000
5 1954400510 2015-02-18 510000        3      2           1680     8080
# … with 14 more variables: floors <dbl>, waterfront <lgl>,
#   view <int>, condition <fct>, grade <fct>, sqft_above <int>,
#   sqft_basement <int>, yr_built <int>, yr_renovated <int>,
#   zipcode <fct>, lat <dbl>, long <dbl>, sqft_living15 <int>,
#   sqft_lot15 <int>
```

</div>

</div>


Now, we will dig into each of the modeling steps listed above.

### 1. Quick exploration

Take a quick look at distributions of all the variables to check for anything irregular. 

Quantitative variables:

<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='co'># house_prices %&gt;% </span>
<span class='co'>#   select(where(is.numeric)) %&gt;% </span>
<span class='co'>#   pivot_longer(cols = everything(),</span>
<span class='co'>#                names_to = "variable", </span>
<span class='co'>#                values_to = "value") %&gt;% </span>
<span class='co'>#   ggplot(aes(x = value)) +</span>
<span class='co'>#   geom_histogram(bins = 30) +</span>
<span class='co'>#   facet_wrap(vars(variable), </span>
<span class='co'>#              scales = "free")</span>

<span class='va'>house_prices</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/pkg/naniar/man/where.html'>where</a></span><span class='op'>(</span><span class='va'>is.numeric</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'>DataExplorer</span><span class='fu'>::</span><span class='fu'><a href='http://boxuancui.github.io/DataExplorer/reference/plot_histogram.html'>plot_histogram</a></span><span class='op'>(</span>theme_config <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggtheme.html'>theme_minimal</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>
</code></pre></div>
<img src="figures/expl_quant-1.png" style="display: block; margin: auto;" /></div>

</div>


Things I noticed and pre-processing thoughts:

* Right-skewness in `price` and all variables regarding square footage --> log transform if using linear regression.
* Many 0's in `sqft_basement`, `view`, and `yr_renovated` --> create indicator variables of having that feature vs. not, ie. a variable called `basement` where a `0` indicates no basement (`sqft_basement` = 0) and a `1` indicates a basement (`sqft_basement` > 0).  
* Age of home may be a better, more interpretable variable than year built --> `age_at_sale = year(date) - yr_built`.

<img src="ml-review_images/image-20210624151538139.png" alt="image-20210624151538139" style="zoom:80%;" />

Categorical variables:

<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='co'># house_prices %&gt;% </span>
<span class='co'>#   select(where(is.factor)) %&gt;% </span>
<span class='co'>#   pivot_longer(cols = everything(),</span>
<span class='co'>#                names_to = "variable", </span>
<span class='co'>#                values_to = "value") %&gt;% </span>
<span class='co'>#   ggplot(aes(x = value)) +</span>
<span class='co'>#   geom_bar() +</span>
<span class='co'>#   facet_wrap(vars(variable), </span>
<span class='co'>#              scales = "free", </span>
<span class='co'>#              nrow = 2)</span>

<span class='va'>house_prices</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span>
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/pkg/naniar/man/where.html'>where</a></span><span class='op'>(</span><span class='va'>is.factor</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span>
  <span class='fu'>DataExplorer</span><span class='fu'>::</span><span class='fu'><a href='http://boxuancui.github.io/DataExplorer/reference/plot_bar.html'>plot_bar</a></span><span class='op'>(</span><span class='op'>)</span>
</code></pre></div>
<img src="figures/expl_cat-1.png" style="display: block; margin: auto;" /></div>

</div>


Things I noticed and pre-processing thoughts:

* `condition` and `grade` both have levels with low counts --> make fewer categories.  (这俩变量低频率的类别有很多, 要精简一下)
* `zipcode` has many unique levels --> don't use that variable for now.  (这个基本上都是 unique 的值, 不适合用做因子变量)
* We might consider using the **month the house was sold** as a variable:

<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='va'>house_prices</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/count.html'>count</a></span><span class='op'>(</span>month <span class='op'>=</span> <span class='fu'><a href='http://lubridate.tidyverse.org/reference/month.html'>month</a></span><span class='op'>(</span><span class='va'>date</span>, label <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_bar.html'>geom_col</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>month</span>, y <span class='op'>=</span> <span class='va'>n</span><span class='op'>)</span><span class='op'>)</span>
</code></pre></div>
<img src="figures/unnamed-chunk-3-1.png" style="display: block; margin: auto;" /></div>

</div>


* And, we quickly look at the counts for the `waterfront` variable. Not many houses are waterfront properties.  

<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='va'>house_prices</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/count.html'>count</a></span><span class='op'>(</span><span class='va'>waterfront</span><span class='op'>)</span>
</code></pre></div>

```
# A tibble: 2 x 2
  waterfront     n
  <lgl>      <int>
1 FALSE      21450
2 TRUE         163
```

</div>

</div>


* The only other variable is `id` which isn't used in modeling.

* Before moving on, let's use the `add_n_miss()`(对行进行缺失值计算统计) function from the `naniar` library to see if we have any missing values. And it appears that there aren't any missing values - lucky us!

<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='va'>house_prices</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://rdrr.io/pkg/naniar/man/add_n_miss.html'>add_n_miss</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/count.html'>count</a></span><span class='op'>(</span><span class='va'>n_miss_all</span><span class='op'>)</span>
</code></pre></div>

```
# A tibble: 1 x 2
  n_miss_all     n
       <int> <int>
1          0 21613
```

</div>

</div>



### 2. Data splitting

**NOTE**: I start by doing some manipulating of the dataset to use `log_price` as the response variable rather than `price`. I originally did this using a `step_log()` function after a `recipe()` function (see the next section), but read in this [RStudio Community post](https://community.rstudio.com/t/fit-resamples-prep-and-outcome-transform-behavior/83891/2), in the comment by Max Kuhn, that **it's better to transform the outcome before doing the modeling**. There is also a discussion of this in the [Skipping steps for new data](https://www.tmwr.org/recipes.html#skip-equals-true) section of the Kuhn & Silge ***Tidy Modeling with R* book**.

> 

Then, we split the data into: training + testing datasets. 

We use the training data to **fit different types of models** and **to tune parameters** of those models if needed, and to help us choose our best models (or maybe best few). 

The testing dataset is saved for the very end to compare a small subset of models and to **give an estimate of the performance** on data the model hasn't seen. 

The `initial_split()` function from the `rsample` library (part of `tidymodels`) is used to create this split. We just do random splitting with this dataset, but there are other arguments that allow you to do **stratified sampling**. Then we use `training()` and `testing()` to extract the two datasets, `house_training` and `house_testing`. 

<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span><span class='op'>(</span><span class='fl'>327</span><span class='op'>)</span> <span class='co'>#for reproducibility</span>

<span class='va'>house_prices</span> <span class='op'>&lt;-</span> <span class='va'>house_prices</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>log_price <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>log</a></span><span class='op'>(</span><span class='va'>price</span>, base <span class='op'>=</span> <span class='fl'>10</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='va'>price</span><span class='op'>)</span>

<span class='co'># Randomly assigns 75% of the data to training.</span>
<span class='va'>house_split</span> <span class='op'>&lt;-</span> <span class='fu'>initial_split</span><span class='op'>(</span><span class='va'>house_prices</span>, 
                             prop <span class='op'>=</span> <span class='fl'>.75</span><span class='op'>)</span>
<span class='va'>house_split</span>
</code></pre></div>

```
<Analysis/Assess/Total>
<16209/5404/21613>
```

<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='co'>#&lt;training/testing/total&gt;</span>

<span class='va'>house_training</span> <span class='op'>&lt;-</span> <span class='fu'>training</span><span class='op'>(</span><span class='va'>house_split</span><span class='op'>)</span>
<span class='va'>house_testing</span> <span class='op'>&lt;-</span> <span class='fu'>testing</span><span class='op'>(</span><span class='va'>house_split</span><span class='op'>)</span>
</code></pre></div>
</div>

</div>


### 3. Data pre-processing

**This step may  not seem very time consuming in this example**, but you will often come back to this step and spend a lot of time trying different variable transformations. You should make sure to work closely with the people who use and create the data during this step. They are a crucial part of the process.

* We use the `recipe()` function to define the **response/outcome variable** and the **predictor variables.** 

* A variety of `step_xxx()` functions can be used to do any data **pre-processing/transforming**. Find them all [here](https://www.tidymodels.org/find/recipes/). I used a few, with brief descriptions in the code. I also used some selector functions, like `all_predictors()` and `all_nominal()` to help me select the right variables. For suggestions on which `step_xxx()` functions to use with which engines, see this list of functions with [ 📌 example templates](https://usemodels.tidymodels.org/reference/templates.html#examples). (Thank you Alison Hill, for showing me this resource via [R Studio Community](https://community.rstudio.com/t/tidymodels-lasso-scaled-variables/99256).)

* One thing that is different here from what you might be used to is that we explicitly make dummy variables with the `step_dummy()` function. **We don't need to always do that - it depends on the model we use(不是所有的模型都要求转换哑变量)**. The [ 📌 recommended preprocessing](https://www.tmwr.org/pre-proc-table.html) appendix of the *Tidy Modeling with R* book is a good place to look for reference.  

* We also use `step_normalize()` here to **center and scale** our numeric predictor variables. Even though this is the default in the `glmnet` engine (see next step),  🔥  **this is important to ensure that this step happens with new data**.

* The `update_roles()` function is used to change the **roles of some variables**. For us, these are variables we may want to include for evaluation purposes but will not be used in building the model. I chose the role of `evaluative` but you could name that role anything you want, eg. `id`, `extra`, `junk` (maybe a bad idea?).

<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='va'>house_recipe</span> <span class='op'>&lt;-</span> <span class='fu'>recipe</span><span class='op'>(</span><span class='va'>log_price</span> <span class='op'>~</span> <span class='va'>.</span>, <span class='co'>#short-cut, . = all other vars</span>
                       data <span class='op'>=</span> <span class='va'>house_training</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='co'># Pre-processing:</span>
  <span class='co'># Remove, redundant to sqft_living and sqft_lot</span>
  <span class='fu'>step_rm</span><span class='op'>(</span><span class='va'>sqft_living15</span>, <span class='va'>sqft_lot15</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span>
  <span class='co'># log sqft variables (without price)</span>
  <span class='fu'>step_log</span><span class='op'>(</span><span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>starts_with</a></span><span class='op'>(</span><span class='st'>"sqft"</span><span class='op'>)</span>,
           <span class='op'>-</span><span class='va'>sqft_basement</span>, 
           base <span class='op'>=</span> <span class='fl'>10</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='co'># I originally had the step_log() function below</span>
  <span class='co'># but instead did the transformation before</span>
  <span class='co'># the recipe because this will mess up the </span>
  <span class='co'># predict() function</span>
  <span class='co'># step_log(price, base = 10) %&gt;% </span>
  <span class='co'># 📝在 recipes 开始之前, 对 Y 进行 step_log 这样对 predict() function</span>
  <span class='co'># 的预测值不会造成干扰</span>
  
  <span class='co'># new grade variable combines low grades &amp; high grades</span>
  <span class='co'># indicator variables for basement, renovate, and view </span>
  <span class='co'># waterfront to numeric</span>
  <span class='co'># age of house</span>
  <span class='fu'>step_mutate</span><span class='op'>(</span>grade <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/character.html'>as.character</a></span><span class='op'>(</span><span class='va'>grade</span><span class='op'>)</span>,
              grade <span class='op'>=</span> <span class='fu'><a href='https://forcats.tidyverse.org/reference/fct_relevel.html'>fct_relevel</a></span><span class='op'>(</span>
                        <span class='fu'><a href='https://dplyr.tidyverse.org/reference/case_when.html'>case_when</a></span><span class='op'>(</span>
                          <span class='va'>grade</span> <span class='op'><a href='https://rdrr.io/r/base/match.html'>%in%</a></span> <span class='st'>"1"</span><span class='op'>:</span><span class='st'>"6"</span>   <span class='op'>~</span> <span class='st'>"below_average"</span>,
                          <span class='va'>grade</span> <span class='op'><a href='https://rdrr.io/r/base/match.html'>%in%</a></span> <span class='st'>"10"</span><span class='op'>:</span><span class='st'>"13"</span> <span class='op'>~</span> <span class='st'>"high"</span>,
                          <span class='cn'>TRUE</span> <span class='op'>~</span> <span class='va'>grade</span>
                        <span class='op'>)</span>,
                        <span class='st'>"below_average"</span>,<span class='st'>"7"</span>,<span class='st'>"8"</span>,<span class='st'>"9"</span>,<span class='st'>"high"</span><span class='op'>)</span>,
              basement <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/numeric.html'>as.numeric</a></span><span class='op'>(</span><span class='va'>sqft_basement</span> <span class='op'>==</span> <span class='fl'>0</span><span class='op'>)</span>,
              renovated <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/numeric.html'>as.numeric</a></span><span class='op'>(</span><span class='va'>yr_renovated</span> <span class='op'>==</span> <span class='fl'>0</span><span class='op'>)</span>,
              view <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/numeric.html'>as.numeric</a></span><span class='op'>(</span><span class='va'>view</span> <span class='op'>==</span> <span class='fl'>0</span><span class='op'>)</span>,
              waterfront <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/numeric.html'>as.numeric</a></span><span class='op'>(</span><span class='va'>waterfront</span><span class='op'>)</span>,
              age_at_sale <span class='op'>=</span> <span class='fu'><a href='http://lubridate.tidyverse.org/reference/year.html'>year</a></span><span class='op'>(</span><span class='va'>date</span><span class='op'>)</span> <span class='op'>-</span> <span class='va'>yr_built</span><span class='op'>)</span><span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='co'># Remove sqft_basement, yr_renovated, and yr_built</span>
  <span class='fu'>step_rm</span><span class='op'>(</span><span class='va'>sqft_basement</span>, 
          <span class='va'>yr_renovated</span>, 
          <span class='va'>yr_built</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='co'># Create a month variable</span>
  <span class='fu'>step_date</span><span class='op'>(</span><span class='va'>date</span>, 
            features <span class='op'>=</span> <span class='st'>"month"</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='co'># Make these evaluative variables, not included in modeling</span>
  <span class='fu'>update_role</span><span class='op'>(</span><span class='fu'><a href='https://tidyselect.r-lib.org/reference/all_of.html'>all_of</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"id"</span>,
                       <span class='st'>"date"</span>,
                       <span class='st'>"zipcode"</span>, 
                       <span class='st'>"lat"</span>, 
                       <span class='st'>"long"</span><span class='op'>)</span><span class='op'>)</span>,
              new_role <span class='op'>=</span> <span class='st'>"evaluative"</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='co'># Create indicator variables for factors/character/nominal</span>
  <span class='co'># explicitly remove outcome, even though outcome isn't nominal</span>
  <span class='co'># this is important in cases when we have a nominal output (eg. logistic)</span>
  <span class='fu'>step_dummy</span><span class='op'>(</span><span class='fu'>all_nominal</span><span class='op'>(</span><span class='op'>)</span>, 
             <span class='op'>-</span><span class='fu'>all_outcomes</span><span class='op'>(</span><span class='op'>)</span>, 
             <span class='op'>-</span><span class='fu'>has_role</span><span class='op'>(</span>match <span class='op'>=</span> <span class='st'>"evaluative"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'>step_normalize</span><span class='op'>(</span><span class='fu'>all_predictors</span><span class='op'>(</span><span class='op'>)</span>, 
                 <span class='op'>-</span><span class='fu'>all_nominal</span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>
</code></pre></div>
</div>

</div>


Apply to training dataset, just to see what happens. This is not a necessary step,  📝 but **I often like to check to see that everything is as expected**. 

For example, notice the names of the variables are the same as before but they have been transformed, eg. `sqft_living` is actually log base 10 of square feet of living. This confused me the first time, so I was glad I ran this extra step. Better to be confused now than later in the process 😀.

<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='va'>training_data_prepared</span> <span class='op'>&lt;-</span> 
<span class='va'>house_recipe</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'>prep</span><span class='op'>(</span><span class='va'>house_training</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span>
  <span class='co'># using bake(new_data = NULL) gives same result as juice()</span>
  <span class='co'># bake(new_data = NULL)</span>
  <span class='fu'>juice</span><span class='op'>(</span><span class='op'>)</span> 

<span class='va'>training_data_prepared</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'>plot_histogram</span><span class='op'>(</span><span class='op'>)</span>
</code></pre></div>
<img src="figures/apply_recipe-1.png" style="display: block; margin: auto;" /></div>

</div>


### 4. Fitting model(s)

Now that we have split and pre-processed the data, we are ready to model! First, we will model `log_price` using simple linear regression.

We will do this using some modeling functions from the `parsnip` package. Find all available functions [ 🔍Explore tidymodels - Search parsnip models](https://www.tidymodels.org/find/parsnip/). [ 📝 Here](https://parsnip.tidymodels.org/reference/linear_reg.html) is the detail for linear regression.

In order to define our model, we need to do these steps:

* **Define the model type**, which is the general type of model you want to fit(选着模型).    
* **Set the engine**, which defines the package/function that will be used to fit the model(选着使用哪个 📦).  
* **Set the mode**, which is either "**regression**" for continuous response variables or "**classification**" for binary/categorical response variables. (Note that for linear regression, it can only be "regression", so we don't NEED this step in this case.)  遗憾的是, 目前并不包含想生存分析这种包含时间的类型
* (OPTIONAL) Set arguments to tune. We'll see an example of this later.

<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='va'>house_linear_mod</span> <span class='op'>&lt;-</span> 
  <span class='co'># Define a linear regression model</span>
  <span class='fu'>linear_reg</span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='co'># Set the engine to "lm" (lm() function is used to fit model)</span>
  <span class='fu'>set_engine</span><span class='op'>(</span><span class='st'>"lm"</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='co'># Not necessary here, but good to remember for other models</span>
  <span class='fu'>set_mode</span><span class='op'>(</span><span class='st'>"regression"</span><span class='op'>)</span>

<span class='va'>house_linear_mod</span>
</code></pre></div>

```
Linear Regression Model Specification (regression)

Computational engine: lm 
```

</div>

</div>


This is just setting up the process. We haven't fit the model to data yet, and there's still one more step before we do - creating a **workflow**! This combines the preprocessing and model definition steps.

<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='va'>house_lm_wf</span> <span class='op'>&lt;-</span> 
  <span class='co'># Set up the workflow</span>
  <span class='fu'>workflow</span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='co'># Add the recipe</span>
  <span class='fu'>add_recipe</span><span class='op'>(</span><span class='va'>house_recipe</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='co'># Add the modeling</span>
  <span class='fu'>add_model</span><span class='op'>(</span><span class='va'>house_linear_mod</span><span class='op'>)</span>
<span class='co'># 这里有点像是 scikit-learn 里面的创建模型对象, 只是这个包含了 rawdata input ➡ data processing  ➡  ready to fit data</span>
<span class='va'>house_lm_wf</span>
</code></pre></div>

```
══ Workflow ══════════════════════════════════════════════════════════
Preprocessor: Recipe
Model: linear_reg()

── Preprocessor ──────────────────────────────────────────────────────
7 Recipe Steps

• step_rm()
• step_log()
• step_mutate()
• step_rm()
• step_date()
• step_dummy()
• step_normalize()

── Model ─────────────────────────────────────────────────────────────
Linear Regression Model Specification (regression)

Computational engine: lm 
```

</div>

</div>


Now we are finally ready to fit the model! After all that work, this part seems easy. We first use the `fit()` function to fit the model, telling it **which data set we want to fit the model to**. Then we use some other functions to display the results nicely.

<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='va'>house_lm_fit</span> <span class='op'>&lt;-</span> 
  <span class='co'># Tell it the workflow</span>
  <span class='va'>house_lm_wf</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='co'># Fit the model to the training data</span>
  <span class='fu'>fit</span><span class='op'>(</span><span class='va'>house_training</span><span class='op'>)</span>

<span class='co'># Display the results nicely</span>
<span class='va'>house_lm_fit</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'>pull_workflow_fit</span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'>tidy</span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/across.html'>across</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/pkg/naniar/man/where.html'>where</a></span><span class='op'>(</span><span class='va'>is.numeric</span><span class='op'>)</span>, <span class='op'>~</span><span class='fu'><a href='https://rdrr.io/r/base/Round.html'>round</a></span><span class='op'>(</span><span class='va'>.x</span>,<span class='fl'>3</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> 
</code></pre></div>

```
# A tibble: 31 x 5
   term        estimate std.error statistic p.value
   <chr>          <dbl>     <dbl>     <dbl>   <dbl>
 1 (Intercept)    5.67      0.001   5345.         0
 2 bedrooms      -0.015     0.001    -10.8        0
 3 bathrooms      0.026     0.002     13.3        0
 4 sqft_living    0.053     0.005     11.3        0
 5 sqft_lot      -0.014     0.001    -10.7        0
 6 floors         0.013     0.002      7.64       0
 7 waterfront     0.017     0.001     15.1        0
 8 view          -0.017     0.001    -14.8        0
 9 sqft_above     0.026     0.005      5.66       0
10 basement      -0.02      0.002     -8.90       0
# … with 21 more rows
```

</div>

</div>



### 6. Evaluate & compare models

(I realize we skipped #5. Don't worry, we'll get to it.)

To evaluate the model, we will use cross-validation (CV), specifically 5-fold CV.

 First, we set up the five folds of the training data using the `vfold_cv()` function. 

<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span><span class='op'>(</span><span class='fl'>1211</span><span class='op'>)</span> <span class='co'># for reproducibility</span>
<span class='va'>house_cv</span> <span class='op'>&lt;-</span> <span class='fu'>vfold_cv</span><span class='op'>(</span><span class='va'>house_training</span>, v <span class='op'>=</span> <span class='fl'>5</span><span class='op'>)</span>
</code></pre></div>
</div>

</div>


Then, we fit the model using the 5-fold dataset we just created (When I first did this, I thought I wouldn't have to do both the previous step of fitting a model on the training data AND this step, but I couldn't figure out how to extract the final model from the CV data ... so this was my solution at the time ... and it turns out you DO need to do both as noted by Julia Silge in this [ 📌 tidymodels: fastest way to extract a model object from fit_resamples() results - Machine Learning and Modeling - RStudio Community](https://community.rstudio.com/t/tidymodels-fastest-way-to-extract-a-model-object-from-fit-resamples-results/73301/3).

<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span><span class='op'>(</span><span class='fl'>456</span><span class='op'>)</span> <span class='co'># For reproducibility - not needed for this algorithm</span>

<span class='va'>house_lm_fit_cv</span> <span class='op'>&lt;-</span>
  <span class='co'># Tell it the workflow</span>
  <span class='va'>house_lm_wf</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='co'># 📝  Fit the model (using the workflow) to the cv data: fit_resamples </span>
  <span class='fu'>fit_resamples</span><span class='op'>(</span><span class='va'>house_cv</span><span class='op'>)</span>

<span class='co'># The evaluation metrics for each fold:</span>
<span class='va'>house_lm_fit_cv</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>id</span>, <span class='va'>.metrics</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://tidyr.tidyverse.org/reference/nest.html'>unnest</a></span><span class='op'>(</span><span class='va'>.metrics</span><span class='op'>)</span> 
</code></pre></div>

```
# A tibble: 10 x 5
   id    .metric .estimator .estimate .config             
   <chr> <chr>   <chr>          <dbl> <chr>               
 1 Fold1 rmse    standard       0.136 Preprocessor1_Model1
 2 Fold1 rsq     standard       0.625 Preprocessor1_Model1
 3 Fold2 rmse    standard       0.135 Preprocessor1_Model1
 4 Fold2 rsq     standard       0.654 Preprocessor1_Model1
 5 Fold3 rmse    standard       0.131 Preprocessor1_Model1
 6 Fold3 rsq     standard       0.674 Preprocessor1_Model1
 7 Fold4 rmse    standard       0.137 Preprocessor1_Model1
 8 Fold4 rsq     standard       0.645 Preprocessor1_Model1
 9 Fold5 rmse    standard       0.136 Preprocessor1_Model1
10 Fold5 rsq     standard       0.644 Preprocessor1_Model1
```

<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Evaluation metrics averaged over all folds:</span>
<span class='fu'>collect_metrics</span><span class='op'>(</span><span class='va'>house_lm_fit_cv</span><span class='op'>)</span>
</code></pre></div>

```
# A tibble: 2 x 6
  .metric .estimator  mean     n std_err .config             
  <chr>   <chr>      <dbl> <int>   <dbl> <chr>               
1 rmse    standard   0.135     5 0.00105 Preprocessor1_Model1
2 rsq     standard   0.648     5 0.00793 Preprocessor1_Model1
```

<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Just to show you where the averages come from:</span>
<span class='va'>house_lm_fit_cv</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>id</span>, <span class='va'>.metrics</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://tidyr.tidyverse.org/reference/nest.html'>unnest</a></span><span class='op'>(</span><span class='va'>.metrics</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>.metric</span>, <span class='va'>.estimator</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/summarise.html'>summarize</a></span><span class='op'>(</span>mean <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>.estimate</span><span class='op'>)</span>,
            n <span class='op'>=</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>n</a></span><span class='op'>(</span><span class='op'>)</span>,
            std_err <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/sd.html'>sd</a></span><span class='op'>(</span><span class='va'>.estimate</span><span class='op'>)</span><span class='op'>/</span><span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>sqrt</a></span><span class='op'>(</span><span class='va'>n</span><span class='op'>)</span><span class='op'>)</span>
</code></pre></div>

```
# A tibble: 2 x 5
# Groups:   .metric [2]
  .metric .estimator  mean     n std_err
  <chr>   <chr>      <dbl> <int>   <dbl>
1 rmse    standard   0.135     5 0.00105
2 rsq     standard   0.648     5 0.00793
```

</div>

</div>


### 7. Apply model to testing data

In this simple scenario, we may be interested in seeing **how the model performs on the testing data** that was left out. The code below will fit the model to the training data and apply it to the testing data. There are other ways we could have done this, but the way we do it here will be useful when we start using more complex models where we need to tune model parameters.

After the model is fit and applied, we collect the performance metrics and display them and show the predictions from the testing data. Notice the the RMSE here is very similar to the cross-validated RMSE we computed in the previous step. 

<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='va'>house_lm_test</span> <span class='op'>&lt;-</span> 
  <span class='co'># The modeling work flow</span>
  <span class='va'>house_lm_wf</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='co'># Use training data to fit the model and apply it to testing data</span>
  <span class='fu'>last_fit</span><span class='op'>(</span><span class='va'>house_split</span><span class='op'>)</span>

<span class='co'># performance metrics from testing data</span>
<span class='fu'>collect_metrics</span><span class='op'>(</span><span class='va'>house_lm_test</span><span class='op'>)</span>
</code></pre></div>

```
# A tibble: 2 x 4
  .metric .estimator .estimate .config             
  <chr>   <chr>          <dbl> <chr>               
1 rmse    standard       0.136 Preprocessor1_Model1
2 rsq     standard       0.654 Preprocessor1_Model1
```

<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='co'># predictions from testing data</span>
<span class='fu'>collect_predictions</span><span class='op'>(</span><span class='va'>house_lm_test</span><span class='op'>)</span> 
</code></pre></div>

```
# A tibble: 5,404 x 5
   id               .pred  .row log_price .config             
   <chr>            <dbl> <int>     <dbl> <chr>               
 1 train/test split  5.49     1      5.35 Preprocessor1_Model1
 2 train/test split  5.64     4      5.78 Preprocessor1_Model1
 3 train/test split  6.08     6      6.09 Preprocessor1_Model1
 4 train/test split  5.59     9      5.36 Preprocessor1_Model1
 5 train/test split  5.49    14      5.60 Preprocessor1_Model1
 6 train/test split  5.74    15      5.72 Preprocessor1_Model1
 7 train/test split  5.79    28      5.82 Preprocessor1_Model1
 8 train/test split  5.73    33      5.84 Preprocessor1_Model1
 9 train/test split  5.56    54      5.77 Preprocessor1_Model1
10 train/test split  5.50    72      5.51 Preprocessor1_Model1
# … with 5,394 more rows
```

</div>

</div>


The code below creates a simple plot to examine predicted vs. actual price (log base 10) from the house data. 

<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='fu'>collect_predictions</span><span class='op'>(</span><span class='va'>house_lm_test</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>log_price</span>, 
             y <span class='op'>=</span> <span class='va'>.pred</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_point.html'>geom_point</a></span><span class='op'>(</span>alpha <span class='op'>=</span> <span class='fl'>.5</span>, 
             size <span class='op'>=</span> <span class='fl'>.5</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_smooth.html'>geom_smooth</a></span><span class='op'>(</span>se <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_abline.html'>geom_abline</a></span><span class='op'>(</span>slope <span class='op'>=</span> <span class='fl'>1</span>, 
              intercept <span class='op'>=</span> <span class='fl'>0</span>, 
              color <span class='op'>=</span> <span class='st'>"darkred"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/labs.html'>labs</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='st'>"Actual log(price)"</span>, 
       y <span class='op'>=</span> <span class='st'>"Predicted log(price)"</span><span class='op'>)</span>
</code></pre></div>
<img src="figures/act_pred_plot-1.png" style="display: block; margin: auto;" /></div>

</div>


Here is the same plot using the **regular price scale(使用 Y 的真实值, 而非转换后的值)**.

<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='fu'>collect_predictions</span><span class='op'>(</span><span class='va'>house_lm_test</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='fl'>10</span><span class='op'>^</span><span class='va'>log_price</span>, 
             y <span class='op'>=</span> <span class='fl'>10</span><span class='op'>^</span><span class='va'>.pred</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_point.html'>geom_point</a></span><span class='op'>(</span>alpha <span class='op'>=</span> <span class='fl'>.5</span>, 
             size <span class='op'>=</span> <span class='fl'>.5</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_smooth.html'>geom_smooth</a></span><span class='op'>(</span>se <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_abline.html'>geom_abline</a></span><span class='op'>(</span>slope <span class='op'>=</span> <span class='fl'>1</span>, 
              intercept <span class='op'>=</span> <span class='fl'>0</span>, 
              color <span class='op'>=</span> <span class='st'>"darkred"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/labs.html'>labs</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='st'>"Actual price"</span>, 
       y <span class='op'>=</span> <span class='st'>"Predicted price"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/scale_continuous.html'>scale_x_continuous</a></span><span class='op'>(</span>labels <span class='op'>=</span> <span class='fu'>scales</span><span class='fu'>::</span><span class='fu'><a href='https://scales.r-lib.org/reference/label_dollar.html'>dollar_format</a></span><span class='op'>(</span>scale <span class='op'>=</span> <span class='fl'>.000001</span>, 
                                                    suffix <span class='op'>=</span> <span class='st'>"M"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/scale_continuous.html'>scale_y_continuous</a></span><span class='op'>(</span>labels <span class='op'>=</span> <span class='fu'>scales</span><span class='fu'>::</span><span class='fu'><a href='https://scales.r-lib.org/reference/label_dollar.html'>dollar_format</a></span><span class='op'>(</span>scale <span class='op'>=</span> <span class='fl'>.000001</span>, 
                                                    suffix <span class='op'>=</span> <span class='st'>"M"</span><span class='op'>)</span><span class='op'>)</span>
</code></pre></div>
<img src="figures/price_pred_plot-1.png" style="display: block; margin: auto;" /></div>

</div>


### 9. Question the data and model

(We'll go back to step #8 in a moment)

When we use create models, **it is important to think about how the model will be used and specifically how the model could do harm**. One thing to notice in the graphs above/below is that the price of **lower priced homes: 高估** are, on average, overestimated whereas the price of **higher priced homes: 低估** are, on average, underestimated. 

<img src="ml-review_images/image-20210624162941193.png" alt="image-20210624162941193" style="zoom:30%;" />

What if this model was used to determine the price of homes for property tax purposes? Then lower priced homes would be overtaxed while higher priced homes would be undertaxed. 

There are many different ways we might continue to examine this model (eg. are there differences by zipcode) but for now, we'll move on.

### 8. Use the model 

How might use this model? One simple way is to predict new values. We saw that we could add the predicted values to the test data using the `collect_predictions()` function. Below, I predict the value for one new observation using the `predict()` function. We put the values of each variable in a dataset, in this case a `tibble()`. We need to have values for all the variables that were originally in the dataset passed to the `recipe()`, 📝 **even the evaluation ones that don't get used in the model**. We can **have extra variables** in there, though, like the one I have called `garbage`. I show a predicted value (for a linear model, `type = "numeric"`) and a confidence interval (`type = "conf_int"`). (**简单说就是: 变量名要一样, 只能多不能少**)

 📝 **NOTE**: This is a bit of an aside, but an important one. If I would have used the `step_log()` function to transform the response variable `price` in the pre-processing step, rather than transforming it before that, we would see an error message in the `predict()` below **because it would try to run that transformation step, but there wouldn't be a `price` variable**(这就是要在 recipes 之前进行 Y 的数据转换, 这样的话在运行数据预测的时候才不会出错, 因为新的数据有可能是没有 Y 变量的). **In real life, it would usually be the case that you don't have a value for the variable you are trying to predict**.

I originally tried to solve this problem by adding `skip = TRUE` to the `step_log()` function, but then the evaluation metrics in `collect_metrics()` compared the predicted log price to the actual price - yikes! This is discussed in a few places online - [tuning fails when recipe step affects an outcome with skip = TRUE · Issue #47 · tidymodels/workflows](https://github.com/tidymodels/workflows/issues/47)'s one. 

> 
>
> 🔥  📝 : The solution is to transform the response variable before doing any of the modeling steps, as I mentioned in the Data splitting section.
>
> 

<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span>
  <span class='va'>house_lm_fit</span>,
  new_data <span class='op'>=</span> <span class='fu'><a href='https://tibble.tidyverse.org/reference/tibble.html'>tibble</a></span><span class='op'>(</span>id <span class='op'>=</span> <span class='st'>"0705700390"</span>,
                    date <span class='op'>=</span> <span class='fu'><a href='http://lubridate.tidyverse.org/reference/ymd.html'>ymd</a></span><span class='op'>(</span><span class='st'>"2014-09-03"</span><span class='op'>)</span>,
                    bedrooms <span class='op'>=</span> <span class='fl'>3</span>,
                    bathrooms <span class='op'>=</span> <span class='fl'>2.25</span>,
                    sqft_living <span class='op'>=</span> <span class='fl'>2020</span>,
                    sqft_lot <span class='op'>=</span> <span class='fl'>8379</span>,
                    floors <span class='op'>=</span> <span class='fl'>2</span>,
                    waterfront <span class='op'>=</span> <span class='cn'>FALSE</span>,
                    view <span class='op'>=</span> <span class='fl'>0</span>,
                    condition <span class='op'>=</span> <span class='st'>"3"</span>,
                    grade <span class='op'>=</span> <span class='st'>"7"</span>,
                    sqft_above <span class='op'>=</span> <span class='fl'>2020</span>,
                    sqft_basement <span class='op'>=</span> <span class='fl'>0</span>,
                    yr_built <span class='op'>=</span> <span class='fl'>1994</span>,
                    yr_renovated <span class='op'>=</span> <span class='fl'>0</span>,
                    zipcode <span class='op'>=</span> <span class='st'>"98038"</span>,
                    lat <span class='op'>=</span> <span class='fl'>47.3828</span>,
                    long <span class='op'>=</span> <span class='op'>-</span><span class='fl'>122.023</span>,
                    sqft_living15 <span class='op'>=</span> <span class='fl'>2020</span>,
                    sqft_lot15 <span class='op'>=</span> <span class='fl'>8031</span>,
                    garbage <span class='op'>=</span> <span class='st'>"look, it's garbage"</span><span class='op'>)</span>,
  type <span class='op'>=</span> <span class='st'>"numeric"</span>,
  level <span class='op'>=</span> <span class='fl'>0.95</span>
<span class='op'>)</span>
</code></pre></div>

```
# A tibble: 1 x 1
  .pred
  <dbl>
1  5.55
```

<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span>
  <span class='va'>house_lm_fit</span>,
  new_data <span class='op'>=</span> <span class='fu'><a href='https://tibble.tidyverse.org/reference/tibble.html'>tibble</a></span><span class='op'>(</span>id <span class='op'>=</span> <span class='st'>"0705700390"</span>,
                    date <span class='op'>=</span> <span class='fu'><a href='http://lubridate.tidyverse.org/reference/ymd.html'>ymd</a></span><span class='op'>(</span><span class='st'>"2014-09-03"</span><span class='op'>)</span>,
                    bedrooms <span class='op'>=</span> <span class='fl'>3</span>,
                    bathrooms <span class='op'>=</span> <span class='fl'>2.25</span>,
                    sqft_living <span class='op'>=</span> <span class='fl'>2020</span>,
                    sqft_lot <span class='op'>=</span> <span class='fl'>8379</span>,
                    floors <span class='op'>=</span> <span class='fl'>2</span>,
                    waterfront <span class='op'>=</span> <span class='cn'>FALSE</span>,
                    view <span class='op'>=</span> <span class='fl'>0</span>,
                    condition <span class='op'>=</span> <span class='st'>"3"</span>,
                    grade <span class='op'>=</span> <span class='st'>"7"</span>,
                    sqft_above <span class='op'>=</span> <span class='fl'>2020</span>,
                    sqft_basement <span class='op'>=</span> <span class='fl'>0</span>,
                    yr_built <span class='op'>=</span> <span class='fl'>1994</span>,
                    yr_renovated <span class='op'>=</span> <span class='fl'>0</span>,
                    zipcode <span class='op'>=</span> <span class='st'>"98038"</span>,
                    lat <span class='op'>=</span> <span class='fl'>47.3828</span>,
                    long <span class='op'>=</span> <span class='op'>-</span><span class='fl'>122.023</span>,
                    sqft_living15 <span class='op'>=</span> <span class='fl'>2020</span>,
                    sqft_lot15 <span class='op'>=</span> <span class='fl'>8031</span>,
                    garbage <span class='op'>=</span> <span class='st'>"look, it's garbage"</span><span class='op'>)</span>,
  type <span class='op'>=</span> <span class='st'>"conf_int"</span>,
  level <span class='op'>=</span> <span class='fl'>0.95</span>
<span class='op'>)</span>
</code></pre></div>

```
# A tibble: 1 x 2
  .pred_lower .pred_upper
        <dbl>       <dbl>
1        5.55        5.56
```

</div>

</div>


We could also give it an entire dataset. Here, I just take a sample from the original dataset, add an extra variable (just to show you that you can have more than what you need), and predict with it.

<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span><span class='op'>(</span><span class='fl'>327</span><span class='op'>)</span>

<span class='va'>fake_new_data</span> <span class='op'>&lt;-</span> <span class='va'>house_prices</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/sample_n.html'>sample_n</a></span><span class='op'>(</span><span class='fl'>20</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>extra_var <span class='op'>=</span> <span class='fl'>1</span><span class='op'>:</span><span class='fl'>20</span><span class='op'>)</span>

<span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>house_lm_fit</span>, 
        <span class='va'>fake_new_data</span><span class='op'>)</span>
</code></pre></div>

```
# A tibble: 20 x 1
   .pred
   <dbl>
 1  5.55
 2  5.50
 3  5.61
 4  5.36
 5  5.54
 6  5.59
 7  5.56
 8  5.65
 9  5.34
10  6.40
11  5.68
12  5.80
13  5.98
14  5.56
15  5.49
16  5.61
17  5.73
18  5.40
19  5.96
20  5.62
```

</div>

</div>


Since the `predict()` function will always return the same number of rows and in the same order as the dataset we put in, we can easily append the prediction to the dataset.

<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='va'>fake_new_data</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/bind.html'>bind_cols</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>house_lm_fit</span>,
                    <span class='va'>fake_new_data</span><span class='op'>)</span><span class='op'>)</span> 
</code></pre></div>

```
# A tibble: 20 x 23
   id        date       bedrooms bathrooms sqft_living sqft_lot floors
   <chr>     <date>        <int>     <dbl>       <int>    <int>  <dbl>
 1 72023306… 2014-07-21        3      2.5         2020     5613    2  
 2 66790010… 2014-12-18        3      2.5         1660     7388    2  
 3 76822003… 2014-07-28        3      2.25        1960     8875    1  
 4 61502004… 2014-05-13        2      0.75         650     5360    1  
 5 86455113… 2014-12-01        3      1.75        1810    21138    1  
 6 93210101… 2015-03-12        3      1.75        1390     8980    1  
 7 78532708… 2014-08-05        3      2.5         2230     7934    2  
 8 05100029… 2015-04-07        4      1           1640     4200    1.5
 9 19016000… 2014-06-26        2      1            720     8040    1  
10 12250690… 2014-05-05        7      8          13540   307752    3  
11 11050007… 2015-01-23        3      1.5         1570    10824    2  
12 36297601… 2014-08-21        3      2.5         2490     4904    2  
13 75010000… 2014-11-21        4      3.5         3020    12750    2  
14 86455400… 2014-07-25        3      2           1790     8228    1  
15 21720002… 2015-03-23        2      1           1150    11250    1  
16 79670002… 2014-11-21        3      2.5         1930     4000    2  
17 40778002… 2014-06-10        3      1.5         2010     9480    1  
18 04250000… 2014-10-21        2      1           1150     5695    1  
19 95418001… 2014-10-10        5      2.5         3490    18850    1  
20 43182004… 2014-05-22        3      2.25        1470     1578    2  
# … with 16 more variables: waterfront <lgl>, view <int>,
#   condition <fct>, grade <fct>, sqft_above <int>,
#   sqft_basement <int>, yr_built <int>, yr_renovated <int>,
#   zipcode <fct>, lat <dbl>, long <dbl>, sqft_living15 <int>,
#   sqft_lot15 <int>, log_price <dbl>, extra_var <int>, .pred <dbl>
```

</div>

</div>


We could also add a confidence interval and use the `relocate()` function to move around some variables.

<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='va'>fake_new_data</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/bind.html'>bind_cols</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>house_lm_fit</span>,
                    <span class='va'>fake_new_data</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/bind.html'>bind_cols</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>house_lm_fit</span>,
                    <span class='va'>fake_new_data</span>, 
                    type <span class='op'>=</span> <span class='st'>"conf_int"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='co'># put the pred col after the log_price col</span>
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/relocate.html'>relocate</a></span><span class='op'>(</span><span class='va'>log_price</span>, <span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>starts_with</a></span><span class='op'>(</span><span class='st'>".pred"</span><span class='op'>)</span>, 
           .after <span class='op'>=</span> <span class='va'>id</span><span class='op'>)</span>
</code></pre></div>

```
# A tibble: 20 x 25
   id      log_price .pred .pred_lower .pred_upper date       bedrooms
   <chr>       <dbl> <dbl>       <dbl>       <dbl> <date>        <int>
 1 720233…      5.72  5.55        5.54        5.56 2014-07-21        3
 2 667900…      5.45  5.50        5.49        5.51 2014-12-18        3
 3 768220…      5.26  5.61        5.60        5.62 2014-07-28        3
 4 615020…      5.36  5.36        5.35        5.37 2014-05-13        2
 5 864551…      5.48  5.54        5.53        5.55 2014-12-01        3
 6 932101…      5.44  5.59        5.58        5.60 2015-03-12        3
 7 785327…      5.65  5.56        5.55        5.57 2014-08-05        3
 8 051000…      5.92  5.65        5.64        5.66 2015-04-07        4
 9 190160…      5.32  5.34        5.33        5.35 2014-06-26        2
10 122506…      6.36  6.40        6.38        6.43 2014-05-05        7
11 110500…      5.36  5.68        5.66        5.69 2015-01-23        3
12 362976…      5.80  5.80        5.79        5.81 2014-08-21        3
13 750100…      5.93  5.98        5.97        5.99 2014-11-21        4
14 864554…      5.50  5.56        5.55        5.57 2014-07-25        3
15 217200…      5.41  5.49        5.48        5.50 2015-03-23        2
16 796700…      5.54  5.61        5.60        5.62 2014-11-21        3
17 407780…      5.63  5.73        5.72        5.74 2014-06-10        3
18 042500…      5.26  5.40        5.38        5.41 2014-10-21        2
19 954180…      5.96  5.96        5.94        5.97 2014-10-10        5
20 431820…      5.64  5.62        5.61        5.63 2014-05-22        3
# … with 18 more variables: bathrooms <dbl>, sqft_living <int>,
#   sqft_lot <int>, floors <dbl>, waterfront <lgl>, view <int>,
#   condition <fct>, grade <fct>, sqft_above <int>,
#   sqft_basement <int>, yr_built <int>, yr_renovated <int>,
#   zipcode <fct>, lat <dbl>, long <dbl>, sqft_living15 <int>,
#   sqft_lot15 <int>, extra_var <int>
```

</div>

</div>


❓  What if we don't want to use the model in this R session? 

That would be quite a common occurrence. After building a model, we would often want to save the model and use it at a later time to apply to new data. We'll get into some more complex ways of doing this eventually, but for now, let's do the following:

1. Save the model using `saveRDS()`. This model is saved to the current project folder (assuming you're using a project right now), but you could save it anywhere you'd like.

<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/readRDS.html'>saveRDS</a></span><span class='op'>(</span><span class='va'>house_lm_fit</span>, <span class='st'>"house_lm_fit.rds"</span><span class='op'>)</span>
</code></pre></div>
</div>

</div>


2. Read the model back in using `readRDS()`. Go look at `house_lm_read` in the environment, and you'll see that, indeed, it is the workflow we saved! 🤗

<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='va'>house_lm_read</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/readRDS.html'>readRDS</a></span><span class='op'>(</span><span class='st'>"house_lm_fit.rds"</span><span class='op'>)</span>
</code></pre></div>
</div>

</div>


3. Use the model we read back in to predict new data. Just like we did before, we can use the `predict()` function to predict new values. I use the same `fake_new_data` I used before.

<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='va'>fake_new_data</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/bind.html'>bind_cols</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>house_lm_read</span>,
                    <span class='va'>fake_new_data</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/bind.html'>bind_cols</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>house_lm_read</span>,
                    <span class='va'>fake_new_data</span>, 
                    type <span class='op'>=</span> <span class='st'>"conf_int"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/relocate.html'>relocate</a></span><span class='op'>(</span><span class='va'>log_price</span>, <span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>starts_with</a></span><span class='op'>(</span><span class='st'>".pred"</span><span class='op'>)</span>, 
           .after <span class='op'>=</span> <span class='va'>id</span><span class='op'>)</span>
</code></pre></div>

```
# A tibble: 20 x 25
   id      log_price .pred .pred_lower .pred_upper date       bedrooms
   <chr>       <dbl> <dbl>       <dbl>       <dbl> <date>        <int>
 1 720233…      5.72  5.55        5.54        5.56 2014-07-21        3
 2 667900…      5.45  5.50        5.49        5.51 2014-12-18        3
 3 768220…      5.26  5.61        5.60        5.62 2014-07-28        3
 4 615020…      5.36  5.36        5.35        5.37 2014-05-13        2
 5 864551…      5.48  5.54        5.53        5.55 2014-12-01        3
 6 932101…      5.44  5.59        5.58        5.60 2015-03-12        3
 7 785327…      5.65  5.56        5.55        5.57 2014-08-05        3
 8 051000…      5.92  5.65        5.64        5.66 2015-04-07        4
 9 190160…      5.32  5.34        5.33        5.35 2014-06-26        2
10 122506…      6.36  6.40        6.38        6.43 2014-05-05        7
11 110500…      5.36  5.68        5.66        5.69 2015-01-23        3
12 362976…      5.80  5.80        5.79        5.81 2014-08-21        3
13 750100…      5.93  5.98        5.97        5.99 2014-11-21        4
14 864554…      5.50  5.56        5.55        5.57 2014-07-25        3
15 217200…      5.41  5.49        5.48        5.50 2015-03-23        2
16 796700…      5.54  5.61        5.60        5.62 2014-11-21        3
17 407780…      5.63  5.73        5.72        5.74 2014-06-10        3
18 042500…      5.26  5.40        5.38        5.41 2014-10-21        2
19 954180…      5.96  5.96        5.94        5.97 2014-10-10        5
20 431820…      5.64  5.62        5.61        5.63 2014-05-22        3
# … with 18 more variables: bathrooms <dbl>, sqft_living <int>,
#   sqft_lot <int>, floors <dbl>, waterfront <lgl>, view <int>,
#   condition <fct>, grade <fct>, sqft_above <int>,
#   sqft_basement <int>, yr_built <int>, yr_renovated <int>,
#   zipcode <fct>, lat <dbl>, long <dbl>, sqft_living15 <int>,
#   sqft_lot15 <int>, extra_var <int>
```

</div>

</div>



### 5. Tuning model parameters

With the first model, there weren't any parameters to tune. Let's go back to step #5 and look at how the workflow changes when we have to do this extra step. 

Now we are going to try using [Least Absolute Shrinkage and Selection Operator (LASSO)](https://bradleyboehmke.github.io/HOML/regularized-regression.html#why) regression. This method shrinks some coefficients to 0 based on a penalty term. We will use cross-validation to help us find the best penalty term. 

We will set up the model similar to how we set up the linear model, but add a `set_args()` function. The `tune()` argument to the `penalty` term is a placeholder. We are telling it that we are going to tune the penalty parameter later.

<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='va'>house_lasso_mod</span> <span class='op'>&lt;-</span> 
  <span class='co'># Define a lasso model </span>
  <span class='co'># I believe default is mixture = 1(LASOO) so probably don't need </span>
  <span class='fu'>linear_reg</span><span class='op'>(</span>mixture <span class='op'>=</span> <span class='fl'>1</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='co'># Set the engine to "glmnet" </span>
  <span class='fu'>set_engine</span><span class='op'>(</span><span class='st'>"glmnet"</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='co'># The parameters we will tune.</span>
  <span class='fu'>set_args</span><span class='op'>(</span>penalty <span class='op'>=</span> <span class='fu'>tune</span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='co'># Use "regression"</span>
  <span class='fu'>set_mode</span><span class='op'>(</span><span class='st'>"regression"</span><span class='op'>)</span>
</code></pre></div>
</div>

</div>


To see the arguments available for tuning, go to the [Explore Model Arguments](https://www.tidymodels.org/find/parsnip/) section of the `parsnip` documentation and search the model type and engine you are interested in. Below I printed the arguments we can tune for `linear_reg` using `glmnet` (LASSO). We could have also tuned the `mixture` parameter, but **I set it to 1 to explicitly use LASSO**.

<center>
<img src="ml-review_images/image-20210624165434173.png" alt="image-20210624165434173" style="zoom:50%;" />
</center>

And then we create a LASSO workflow. Notice that we're using the same recipe step that we used in the regular linear model.

<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='va'>house_lasso_wf</span> <span class='op'>&lt;-</span> 
  <span class='co'># Set up the workflow</span>
  <span class='fu'>workflow</span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='co'># Add the recipe</span>
  <span class='fu'>add_recipe</span><span class='op'>(</span><span class='va'>house_recipe</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='co'># Add the modeling</span>
  <span class='fu'>add_model</span><span class='op'>(</span><span class='va'>house_lasso_mod</span><span class='op'>)</span>

<span class='va'>house_lasso_wf</span>
</code></pre></div>

```
══ Workflow ══════════════════════════════════════════════════════════
Preprocessor: Recipe
Model: linear_reg()

── Preprocessor ──────────────────────────────────────────────────────
7 Recipe Steps

• step_rm()
• step_log()
• step_mutate()
• step_rm()
• step_date()
• step_dummy()
• step_normalize()

── Model ─────────────────────────────────────────────────────────────
Linear Regression Model Specification (regression)

Main Arguments:
  penalty = tune()
  mixture = 1

Computational engine: glmnet 
```

</div>

</div>


👀 Here's where some of the new steps come in. We use the `grid_regular()` function from the `dials` library to choose some values of the `penalty` parameter for us. Alternatively, we could give it a vector of values we want to try.

<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='va'>penalty_grid</span> <span class='op'>&lt;-</span> <span class='fu'>grid_regular</span><span class='op'>(</span><span class='fu'>penalty</span><span class='op'>(</span><span class='op'>)</span>,
                             levels <span class='op'>=</span> <span class='fl'>20</span><span class='op'>)</span>
<span class='va'>penalty_grid</span> 
</code></pre></div>

```
# A tibble: 20 x 1
    penalty
      <dbl>
 1 1   e-10
 2 3.36e-10
 3 1.13e- 9
 4 3.79e- 9
 5 1.27e- 8
 6 4.28e- 8
 7 1.44e- 7
 8 4.83e- 7
 9 1.62e- 6
10 5.46e- 6
11 1.83e- 5
12 6.16e- 5
13 2.07e- 4
14 6.95e- 4
15 2.34e- 3
16 7.85e- 3
17 2.64e- 2
18 8.86e- 2
19 2.98e- 1
20 1   e+ 0
```

</div>

</div>


Then, use the `tune_grid()` function to fit the model using cross-validation for all `penalty_grid` values and evaluate on all the folds. 

<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='va'>house_lasso_tune</span> <span class='op'>&lt;-</span> 
  <span class='va'>house_lasso_wf</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'>tune_grid</span><span class='op'>(</span>
    resamples <span class='op'>=</span> <span class='va'>house_cv</span>,
    grid <span class='op'>=</span> <span class='va'>penalty_grid</span>
    <span class='op'>)</span>

<span class='va'>house_lasso_tune</span>
</code></pre></div>

```
# Tuning results
# 5-fold cross-validation 
# A tibble: 5 x 4
  splits               id    .metrics          .notes          
  <list>               <chr> <list>            <list>          
1 <split [12967/3242]> Fold1 <tibble [40 × 5]> <tibble [1 × 1]>
2 <split [12967/3242]> Fold2 <tibble [40 × 5]> <tibble [1 × 1]>
3 <split [12967/3242]> Fold3 <tibble [40 × 5]> <tibble [1 × 1]>
4 <split [12967/3242]> Fold4 <tibble [40 × 5]> <tibble [1 × 1]>
5 <split [12968/3241]> Fold5 <tibble [40 × 5]> <tibble [1 × 1]>
```

</div>

</div>


Then look at the cross-validated results in a table.

<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='co'># The rmse for each fold:</span>
<span class='va'>house_lasso_tune</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>id</span>, <span class='va'>.metrics</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://tidyr.tidyverse.org/reference/nest.html'>unnest</a></span><span class='op'>(</span><span class='va'>.metrics</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>.metric</span> <span class='op'>==</span> <span class='st'>"rmse"</span><span class='op'>)</span>
</code></pre></div>

```
# A tibble: 100 x 6
   id     penalty .metric .estimator .estimate .config              
   <chr>    <dbl> <chr>   <chr>          <dbl> <chr>                
 1 Fold1 1   e-10 rmse    standard       0.136 Preprocessor1_Model01
 2 Fold1 3.36e-10 rmse    standard       0.136 Preprocessor1_Model02
 3 Fold1 1.13e- 9 rmse    standard       0.136 Preprocessor1_Model03
 4 Fold1 3.79e- 9 rmse    standard       0.136 Preprocessor1_Model04
 5 Fold1 1.27e- 8 rmse    standard       0.136 Preprocessor1_Model05
 6 Fold1 4.28e- 8 rmse    standard       0.136 Preprocessor1_Model06
 7 Fold1 1.44e- 7 rmse    standard       0.136 Preprocessor1_Model07
 8 Fold1 4.83e- 7 rmse    standard       0.136 Preprocessor1_Model08
 9 Fold1 1.62e- 6 rmse    standard       0.136 Preprocessor1_Model09
10 Fold1 5.46e- 6 rmse    standard       0.136 Preprocessor1_Model10
# … with 90 more rows
```

<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='co'># rmse averaged over all folds:</span>
<span class='va'>house_lasso_tune</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'>collect_metrics</span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>.metric</span> <span class='op'>==</span> <span class='st'>"rmse"</span><span class='op'>)</span> 
</code></pre></div>

```
# A tibble: 20 x 7
    penalty .metric .estimator  mean     n  std_err .config           
      <dbl> <chr>   <chr>      <dbl> <int>    <dbl> <chr>             
 1 1   e-10 rmse    standard   0.135     5 0.00104  Preprocessor1_Mod…
 2 3.36e-10 rmse    standard   0.135     5 0.00104  Preprocessor1_Mod…
 3 1.13e- 9 rmse    standard   0.135     5 0.00104  Preprocessor1_Mod…
 4 3.79e- 9 rmse    standard   0.135     5 0.00104  Preprocessor1_Mod…
 5 1.27e- 8 rmse    standard   0.135     5 0.00104  Preprocessor1_Mod…
 6 4.28e- 8 rmse    standard   0.135     5 0.00104  Preprocessor1_Mod…
 7 1.44e- 7 rmse    standard   0.135     5 0.00104  Preprocessor1_Mod…
 8 4.83e- 7 rmse    standard   0.135     5 0.00104  Preprocessor1_Mod…
 9 1.62e- 6 rmse    standard   0.135     5 0.00104  Preprocessor1_Mod…
10 5.46e- 6 rmse    standard   0.135     5 0.00104  Preprocessor1_Mod…
11 1.83e- 5 rmse    standard   0.135     5 0.00104  Preprocessor1_Mod…
12 6.16e- 5 rmse    standard   0.135     5 0.00104  Preprocessor1_Mod…
13 2.07e- 4 rmse    standard   0.135     5 0.00103  Preprocessor1_Mod…
14 6.95e- 4 rmse    standard   0.135     5 0.000987 Preprocessor1_Mod…
15 2.34e- 3 rmse    standard   0.136     5 0.000857 Preprocessor1_Mod…
16 7.85e- 3 rmse    standard   0.142     5 0.000680 Preprocessor1_Mod…
17 2.64e- 2 rmse    standard   0.161     5 0.000651 Preprocessor1_Mod…
18 8.86e- 2 rmse    standard   0.190     5 0.00106  Preprocessor1_Mod…
19 2.98e- 1 rmse    standard   0.228     5 0.00134  Preprocessor1_Mod…
20 1   e+ 0 rmse    standard   0.228     5 0.00134  Preprocessor1_Mod…
```

</div>

</div>


And, even better, we can visualize the results. We can see that the RMSE stays fairly consistently low until just before $10^{-3}$

<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Visualize rmse vs. penalty</span>
<span class='va'>house_lasso_tune</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'>collect_metrics</span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>.metric</span> <span class='op'>==</span> <span class='st'>"rmse"</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>penalty</span>, y <span class='op'>=</span> <span class='va'>mean</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_point.html'>geom_point</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_path.html'>geom_line</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/scale_continuous.html'>scale_x_log10</a></span><span class='op'>(</span>
   breaks <span class='op'>=</span> <span class='fu'>scales</span><span class='fu'>::</span><span class='fu'><a href='https://scales.r-lib.org/reference/trans_breaks.html'>trans_breaks</a></span><span class='op'>(</span><span class='st'>"log10"</span>, <span class='kw'>function</span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span> <span class='fl'>10</span><span class='op'>^</span><span class='va'>x</span><span class='op'>)</span>,
   labels <span class='op'>=</span> <span class='fu'>scales</span><span class='fu'>::</span><span class='fu'><a href='https://scales.r-lib.org/reference/trans_format.html'>trans_format</a></span><span class='op'>(</span><span class='st'>"log10"</span>,<span class='fu'>scales</span><span class='fu'>::</span><span class='fu'><a href='https://scales.r-lib.org/reference/label_parse.html'>math_format</a></span><span class='op'>(</span><span class='fl'>10</span><span class='op'>^</span><span class='va'>.x</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/labs.html'>labs</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='st'>"penalty"</span>, y <span class='op'>=</span> <span class='st'>"rmse"</span><span class='op'>)</span>
</code></pre></div>
<img src="figures/tune-viz-1.png" style="display: block; margin: auto;" /></div>

</div>


We choose the best penalty parameter as the one with the smallest cross-validated RMSE. The `select_best()` function does this. 

<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='va'>house_lasso_tune</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'>show_best</span><span class='op'>(</span>metric <span class='op'>=</span> <span class='st'>"rmse"</span><span class='op'>)</span>
</code></pre></div>

```
# A tibble: 5 x 7
   penalty .metric .estimator  mean     n std_err .config             
     <dbl> <chr>   <chr>      <dbl> <int>   <dbl> <chr>               
1 1   e-10 rmse    standard   0.135     5 0.00104 Preprocessor1_Model…
2 3.36e-10 rmse    standard   0.135     5 0.00104 Preprocessor1_Model…
3 1.13e- 9 rmse    standard   0.135     5 0.00104 Preprocessor1_Model…
4 3.79e- 9 rmse    standard   0.135     5 0.00104 Preprocessor1_Model…
5 1.27e- 8 rmse    standard   0.135     5 0.00104 Preprocessor1_Model…
```

</div>

</div>



<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Best tuning parameter by smallest rmse</span>
<span class='va'>best_param</span> <span class='op'>&lt;-</span> <span class='va'>house_lasso_tune</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'>select_best</span><span class='op'>(</span>metric <span class='op'>=</span> <span class='st'>"rmse"</span><span class='op'>)</span>
<span class='va'>best_param</span>
</code></pre></div>

```
# A tibble: 1 x 2
       penalty .config              
         <dbl> <chr>                
1 0.0000000001 Preprocessor1_Model01
```

</div>

</div>


There are other ways you can select parameters, like `select_by_one_std_err()` which "selects the most simple model that is within one standard error of the numerically optimal results". To use this, we need at least one more argument: the parameter to sort the model from most simple to most complex. So, if using glmnet's penalty parameter, since a bigger penalty will be a simpler model, I should put `desc(penalty)` in as the argument.

<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Best tuning parameter by smallest rmse</span>
<span class='va'>one_se_param</span> <span class='op'>&lt;-</span> <span class='va'>house_lasso_tune</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'>select_by_one_std_err</span><span class='op'>(</span>metric <span class='op'>=</span> <span class='st'>"rmse"</span>, <span class='fu'><a href='https://dplyr.tidyverse.org/reference/desc.html'>desc</a></span><span class='op'>(</span><span class='va'>penalty</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>one_se_param</span>
</code></pre></div>

```
# A tibble: 1 x 9
   penalty .metric .estimator  mean     n std_err .config .best .bound
     <dbl> <chr>   <chr>      <dbl> <int>   <dbl> <chr>   <dbl>  <dbl>
1 0.000695 rmse    standard   0.135     5 9.87e-4 Prepro… 0.135  0.136
```

</div>

</div>


Because a larger penalty parameter will fit a simpler model (more terms will likely go to zero). I'll go with the `one_se_param`, especially since the RMSE is so close to the "best" model's RMSE.

Once we choose the parameter we want, we adjust the workflow to include the best tuning parameter using the `finalize_workflow()` function.

<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='va'>house_lasso_final_wf</span> <span class='op'>&lt;-</span> <span class='va'>house_lasso_wf</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'>finalize_workflow</span><span class='op'>(</span><span class='va'>one_se_param</span><span class='op'>)</span>
<span class='va'>house_lasso_final_wf</span>
</code></pre></div>

```
══ Workflow ══════════════════════════════════════════════════════════
Preprocessor: Recipe
Model: linear_reg()

── Preprocessor ──────────────────────────────────────────────────────
7 Recipe Steps

• step_rm()
• step_log()
• step_mutate()
• step_rm()
• step_date()
• step_dummy()
• step_normalize()

── Model ─────────────────────────────────────────────────────────────
Linear Regression Model Specification (regression)

Main Arguments:
  penalty = 0.00069519279617756
  mixture = 1

Computational engine: glmnet 
```

</div>

</div>


Now we could fit this to the training data and look at the resulting model. We can see a few of the terms have coefficients of 0 (although not as many as I would have expected).

<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='va'>house_lasso_final_mod</span> <span class='op'>&lt;-</span> <span class='va'>house_lasso_final_wf</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'>fit</span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>house_training</span><span class='op'>)</span>

<span class='va'>house_lasso_final_mod</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'>pull_workflow_fit</span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'>tidy</span><span class='op'>(</span><span class='op'>)</span> 
</code></pre></div>

```
# A tibble: 31 x 3
   term        estimate  penalty
   <chr>          <dbl>    <dbl>
 1 (Intercept)   5.67   0.000695
 2 bedrooms     -0.0135 0.000695
 3 bathrooms     0.0249 0.000695
 4 sqft_living   0.0587 0.000695
 5 sqft_lot     -0.0138 0.000695
 6 floors        0.0127 0.000695
 7 waterfront    0.0161 0.000695
 8 view         -0.0173 0.000695
 9 sqft_above    0.0213 0.000695
10 basement     -0.0180 0.000695
# … with 21 more rows
```

</div>

</div>


We can also visualize variable importance.

<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Visualize variable importance</span>
<span class='va'>house_lasso_final_mod</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'>pull_workflow_fit</span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://rdrr.io/pkg/vip/man/vip.html'>vip</a></span><span class='op'>(</span><span class='op'>)</span>
</code></pre></div>
<img src="figures/vip-1.png" style="display: block; margin: auto;" /></div>

</div>


Lastly, we apply the model to the test data and examine some final metrics. We also show the metrics from the regular linear model. It looks like performance for the LASSO model is ever so slightly better, but just barely. It's also a good sign that these RMSE's are similar to the cross-validated RMSE's.

<div class="layout-chunk" data-layout="l-body">
<div class='toggle-code'><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Fit model with best tuning parameter(s) to training data and apply to test data</span>
<span class='va'>house_lasso_test</span> <span class='op'>&lt;-</span> <span class='va'>house_lasso_final_wf</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'>last_fit</span><span class='op'>(</span><span class='va'>house_split</span><span class='op'>)</span>

<span class='co'># Metrics for model applied to test data</span>
<span class='va'>house_lasso_test</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'>collect_metrics</span><span class='op'>(</span><span class='op'>)</span>
</code></pre></div>

```
# A tibble: 2 x 4
  .metric .estimator .estimate .config             
  <chr>   <chr>          <dbl> <chr>               
1 rmse    standard       0.136 Preprocessor1_Model1
2 rsq     standard       0.655 Preprocessor1_Model1
```

<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Compare to regular linear regression results</span>
<span class='fu'>collect_metrics</span><span class='op'>(</span><span class='va'>house_lm_test</span><span class='op'>)</span>
</code></pre></div>

```
# A tibble: 2 x 4
  .metric .estimator .estimate .config             
  <chr>   <chr>          <dbl> <chr>               
1 rmse    standard       0.136 Preprocessor1_Model1
2 rsq     standard       0.654 Preprocessor1_Model1
```

</div>

</div>


# Ref

[Advanced Data Science in R: Machine Learning review with an intro to the tidymodels package](https://advanced-ds-in-r.netlify.app/posts/2021-03-16-ml-review/)

```{.r .distill-force-highlighting-css}
```
